<!DOCTYPE html>
<html lang="ka">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Shemdeg</title>

<meta name="description" content="shemdeg.github.io">
<meta name="theme-color" content="#0B1216">
<meta name="apple-mobile-web-app-capable" content="yes" /> 
<link rel="icon" href="/icons/shicon.png">


<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wdth,wght@62.5..100,100..900&display=swap" rel="stylesheet">

<style>

  @font-face {
      font-family: 'TBCContractica';
      src: url('./font/TBCContracticaCAPS-Light.ttf') format('truetype');
      font-weight: 300; /* Light */
      font-style: normal;
  }

  @font-face {
      font-family: 'TBCContractica';
      src: url('./font/TBCContracticaCAPS-Regular.ttf') format('truetype');
      font-weight: normal; /* Regular (400) */
      font-style: normal;
  }

  @font-face {
      font-family: 'TBCContractica';
      src: url('./font/TBCContracticaCAPS-Bold.ttf') format('truetype');
      font-weight: bold; /* Bold (700) */
      font-style: normal;
  }

  @font-face {
      font-family: 'TBCContractica';
      src: url('./font/TBCContracticaCAPS-Black.ttf') format('truetype');
      font-weight: 900; /* Black */
      font-style: normal;
  }

  :root {
    --bg-color: #121212;
    --widget-color: #1E1E1E;
    --text-color: #E0E0E0;
    --text-muted-color: color-mix(in srgb, var(--text-color) 80%, transparent);
    --accent-color: #fff;
    --accent-variant-color: #3700B3;
    --text-on-accent-color: #000000;
    --border-radius: 16px;
    --font-family: "TBCContractica", sans-serif;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  /* Disable double-tap to zoom on interactive elements for a faster UI response */
  button, .nav-item, .week-button, .theme-option {
    touch-action: manipulation;
  }

  html {
    color-scheme: dark;
  }

  body {
    background-color: var(--bg-color);
    color: var(--text-color);
    font-family: var(--font-family);
    padding: 20px 20px 100px 20px; /* Padding for content, space for bottom nav */
    min-height: 100vh;
  }

  /* === LOADER === */
  #loadingOverlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: var(--bg-color); display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    transition: opacity .3s ease, visibility .3s ease;
  }
  #loadingOverlay.hidden { opacity: 0; visibility: hidden; }
  #loadingOverlay .spinner {
    width: 80px; height: 80px; border: 8px solid rgba(255,255,255,0.1);
    border-top: 8px solid var(--accent-color); border-radius: 50%;
    animation: spin 0.5s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  #loadingOverlay p { margin-top: 20px; font-size: 1.1rem; color: var(--text-muted-color); }

  /* === LOGIN OVERLAY === */
  #login-overlay {
    display: none; position: fixed; inset: 0; background: var(--bg-color); z-index: 10000; 
    flex-direction: column; align-items: center; justify-content: center; gap: 20px;
  }
  #login-overlay h1 { font-size: 3rem; color: var(--accent-color); }
  #signInBtn {
    background: #fff; color: #000; border: none; padding: 12px 24px; font-size: 1.1rem; 
    cursor: pointer; display: flex; align-items: center; gap: 12px; border-radius: 8px;
  }
  #signInBtn img { height: 24px; user-select: none; }

  /* === HEADER === */
  header {
    padding: 0 10px 20px 10px;
    display: none; /* Hide header as requested */
  }
  header h1 {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-color);
  }


  .view {
    display: none;
    animation: fadeIn 0.3s ease-in-out;
  }
  .view.active {
    display: block;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes widget-fade-in {
    from { opacity: 0; transform: scale(0.98); }
    to { opacity: 1; transform: scale(1); }
  }

  /* Make main content fill height on live view */
  body[data-active-view="live-view"] {
    display: flex;
    flex-direction: column;
  }
  body[data-active-view="live-view"] .main-content {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }
  body[data-active-view="live-view"] #live-view {
    display: flex; /* Make the view a flex container */
    flex-grow: 1;
    flex-direction: column; /* Stack children vertically */
  }


  /* === WIDGET GRID SYSTEM (Base) === */
  .widget-grid {
    display: grid;    
    gap: 20px;
    
  }
  
  /* === VIEW-SPECIFIC GRID STYLES === */
  #home-grid {
    grid-template-columns: repeat(5, 1fr);
    grid-auto-rows: minmax(0, 1fr); /* Allow rows to grow and shrink */
    height: 100%;
  }

  #resources-grid {
    grid-template-columns: repeat(5, 1fr);
  }

  /* === WIDGET CARD STYLING === */
  .widget-card {
    background-color: var(--widget-color);
    border-radius: var(--border-radius);
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    transition: box-shadow 0.2s ease;
    overflow: hidden; /* Prevent content from spilling out of the card */
    min-height: 150px; /* Set a minimum height for better appearance */
  }
  .widget-card:hover {
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
  }

  .widget-title {
    font-size: 1.15rem;
    font-weight: 500;
    color: var(--text-color);
  }
  .widget-title.has-icon {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .widget-subtitle {
    font-size: 0.9rem;
    color: var(--text-muted-color);
    margin-top: -10px;
  }

  /* === HOME PAGE WIDGETS === */
  #live-time-card {
    text-align: center;
    justify-content: center;
  }
  #live-time-card .time {
    font-size: 3.5rem;
    font-weight: 700;
  }
  #live-time-card .date {
    font-size: 1.2rem;
    color: var(--text-muted-color);
  }

  .quiz-check-btn {
    background-color: var(--accent-color);
    color: var(--text-on-accent-color);
    cursor: pointer;
    display: grid;
    place-items: center;
    transition: all 0.2s ease;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 1px solid transparent;
    align-self: center;
    margin-left: auto;
  }
  .quiz-check-btn.checked {
    background-color: color-mix(in srgb, var(--text-color) 8%, transparent);
    color: var(--text-muted-color);
  }
  .quiz-check-btn.is-missed {
    background-color: #df2222; /* Red for missed */
    color: white;
  }

  #weeks-left-card {
    text-align: center;
    justify-content: center;
    background-color: color-mix(in srgb, var(--accent-color) 8%, var(--widget-color));
    border: 1px solid color-mix(in srgb, var(--accent-color) 20%, transparent);
  }
  #weeks-left-card .number {
    font-size: 3.5rem;
    font-weight: 700;
  }
  #weeks-left-card .label {
    font-size: 1.2rem;
    color: var(--text-muted-color);
  }
  #summary-widget {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    gap: 20px;
    padding: 20px;
  }
  .summary-item {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding: 0;
    gap: 0;
  }
  .summary-label {
    font-size: 1rem;
    color: var(--text-muted-color);
  }
  .summary-value {
    font-size: 2.2rem;
    font-weight: 700;
    line-height: 1.1;
  }
  .subject-card.is-upcoming {
    background-color: color-mix(in srgb, var(--accent-color) 8%, var(--widget-color));
    border: 1px solid color-mix(in srgb, var(--accent-color) 20%, transparent);
    animation: widget-fade-in 0.4s ease-out both;
  }

  /* .subject-card { position: relative; } /* No longer needed */
  .subject-card .topic {
    font-size: 1rem;
    line-height: 1.5;
    color: var(--text-muted-color);    
    white-space: nowrap; /* Keep text on a single line */
    animation: fadeIn 0.3s ease-in-out; /* Add animation on week change */
    text-overflow: ellipsis; /* Add ... for overflow */
    overflow: hidden;
  }
  .subject-card .embed-links {
    display: flex;
    gap: 15px;
    margin-top: auto; /* Pushes to bottom */
    padding-top: 10px;
  }
  .embed-link {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    color: var(--text-muted-color);
    transition: color 0.2s ease;
  }
  .embed-link.is-custom {
    flex-direction: row; /* For custom links, align horizontally */
  }
  .embed-link:hover {
    color: var(--accent-color);
  }
  .embed-link .icon-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: color-mix(in srgb, var(--text-color) 5%, transparent);
    display: grid;
    place-items: center;
    transition: background-color 0.2s ease;
  }
  .embed-link .icon-circle.is-custom {
    width: auto; /* Auto-width for custom links */
    border-radius: 25px; /* Pill shape */
    padding: 0 24px 0 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .embed-link:hover .icon-circle {
    background-color: var(--accent-color);
  }
  .embed-link:hover,
  .embed-link:hover .label,
  .embed-link:hover .icon-circle .material-symbols-outlined {
    color: var(--text-on-accent-color);
  }
  .embed-link .icon-circle .material-symbols-outlined {
    font-size: 24px;
    color: var(--text-color);
    transition: color 0.2s ease;
  }
  .embed-link .label {
    font-size: 0.8rem;
    text-align: center;
  }
  .embed-link .icon-circle.is-custom .label {
    font-size: 0.9rem;
  }

  
  #resources-view .embed-links {
    margin-top: auto; /* Push links to the bottom */
    padding-top: 10px;
  }

  .subjects-widget-container{
    height: 100%;
  }

  /* === SETTINGS PAGE === */
  #settings-grid {
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    align-content: start;
  }
  @media screen and (min-width: 1024px) {
    #settings-grid {
      grid-template-columns: 1fr 1fr 1fr; /* Three equal columns */
    }
  }
  .settings-column {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  @media screen and (min-width: 1024px) {
    #settings-grid {
      grid-template-columns: 1fr 1fr 1fr; /* Three equal columns */
    }
    .settings-column {
      display: flex;
      flex-direction: column;
      gap: 20px;
      height: 100%;
    }
    .settings-column > .widget-card {
      flex-grow: 1; /* Allow widgets to grow to fill the column */
      display: flex; /* Ensure widgets are flex containers */
    }
  }

  .settings-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    flex-wrap: wrap;
  }
  .settings-item:last-child { border-bottom: none; }
  .settings-item .name { flex-grow: 1; font-weight: 500; }
  .settings-item .action-btn {
    background-color: var(--accent-color);
    color: var(--bg-color);
    border: none;
    width: 36px; height: 36px;
    border-radius: 12px;
    cursor: pointer;
    display: grid; place-items: center;
    transition: background-color 0.2s ease;
  }
  .settings-item .action-btn.added {
    background-color: transparent;
    color: var(--accent-color);
    border: 1px solid var(--accent-color);
    cursor: default;
  }
  .widget-card .action-btn.remove { 
    background-color: #B00020; 
    color: white; 
    /* position: absolute;
    top: 15px;
    right: 15px; */
    /* height: 40px; */
    border-radius: 12px;
    align-self: flex-start; /* Align to top of flex container */
  }
  .settings-item .action-btn:hover { filter: brightness(1.2); }
  .settings-item .day-time-select {
    background-color: rgba(255,255,255,0.05);
    color: #ffffff;
    border-radius: 8px;
    padding: 8px 12px;
    font-family: "TBCContractica", sans-serif;
    border: 1px solid transparent;
    transition: border-color 0.2s ease;
    font-weight: 600;
    height: 50px;
  }
  .widget-card .day-time-select, .settings-item .day-time-select {
    background-color: color-mix(in srgb, var(--text-color) 5%, transparent);
    color: var(--text-color);
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-chevron-down' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 20px center;
    background-size: 1em;
    height: 50px;
    padding-right: 45px; /* Ensure text doesn't overlap arrow */
  }
  .day-time-select option { background-color: var(--widget-color); color: var(--text-color); }
  .settings-item .day-time-select:hover, .duration-selector select:hover {
    border-color: var(--accent-color);
  }
  
  .search-input-container {
    position: relative;
    margin-bottom: 15px;
  }
  .search-input-container .material-symbols-outlined {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted-color);
  }
  #catalog-search {
    width: 100%;
    padding: 15px 20px 15px 45px;
    background-color: color-mix(in srgb, var(--text-color) 3%, transparent);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 999px;
    color: var(--text-color);
    font-size: 1rem;
    font-family: "TBCContractica", sans-serif;
    outline: none;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }
  #catalog-search:focus {
    border-color: var(--accent-color);
  }
  .weekday-chooser {
    display: flex;
    gap: 8px;
    justify-content: space-between;
    width: 100%;
    margin-top: 10px;
  }
  .weekday-btn {
    width: 42px;
    height: 48px;
    border-radius: 12px;
    border: 1px solid transparent;
    background-color: color-mix(in srgb, var(--text-color) 5%, transparent);
    color: var(--text-muted-color);
    cursor: pointer;
    display: grid;
    place-items: center;
    font-size: 0.9rem;
    font-weight: 600;
    transition: all 0.2s ease;
    flex: 1;
  }
  .weekday-btn:hover {
    background-color: color-mix(in srgb, var(--text-color) 10%, transparent);
  }
  .weekday-btn.active {
    background-color: var(--accent-color);
    color: var(--bg-color);
  }
  .subject-carousel-content {
    flex-grow: 1; /* Allow the content area to fill vertical space */
    display: flex; /* Make it a flex container */
    flex-direction: column; /* Stack children vertically */
    min-height: 0; /* Necessary for flex-grow in some browsers */
    width: 100%;
  }
  .subject-carousel-nav-container {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }
  .subject-carousel-nav-btn {
    background: color-mix(in srgb, var(--text-color) 10%, transparent);
    border: none; color: var(--text-color); border-radius: 12px;
    height: 60px; cursor: pointer; display: grid; place-items: center;
    flex: 1; /* Make buttons grow to fill space */
    transition: background-color 0.2s ease;
    padding: 4px;
  }
  
  .subject-carousel-nav-btn:hover {
    background: #ffffff20;
  }
  
  .settings-widget-content { flex-grow: 1; min-height: 0; overflow-y: auto; padding-right: 5px; }
  .settings-widget-content::-webkit-scrollbar { width: 6px; }
  .settings-widget-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

  .list-nav-controls {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }
  .list-nav-btn {
    background: rgba(255,255,255,0.08);
    border: none; color: var(--text-color); border-radius: 8px;
    width: 36px; height: 36px; cursor: pointer; display: grid; place-items: center;
  }
  .list-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
  #settings-view .theme-selector .themes {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
  }
  @media screen and (max-width: 100px) {
    #settings-view .theme-selector .themes {
      display: grid;
      grid-template-columns: 1fr 1fr;
    }
  }
  .theme-option {
    border: 2px solid transparent;
    border-radius: 10px;
    padding: 15px;
    cursor: pointer;
    transition: border-color 0.2s ease;
    width: 150px;
  }
  .theme-option.active {
    border-color: var(--accent-color);
  }
  .theme-option .name {
    font-weight: 600;
    margin-bottom: 10px;
  }
  .theme-option .swatches {
    display: flex;
    gap: 5px;
  }
  .theme-option .swatch {
    width: 20px;
    height: 20px;
    border-radius: 50%;
  }
  #settings-view .save-button {
    background-color: var(--accent-color);
    color: var(--bg-color);
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    transition: background-color 0.2s ease;
  }
  #settings-view .logout-button {
    background-color: #B00020;
    color: white;
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    transition: background-color 0.2s ease;
  }
  #settings-view .logout-button:hover {
    background-color: #CF6679;
  }

  /* === BOTTOM NAVIGATION === */
  .bottom-nav {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    background-color: var(--widget-color);
    border-radius: 999px;
    padding: 10px;
    display: flex;
    gap: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    z-index: 1000;
  }
  .nav-item {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: grid;
    place-items: center;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease;
    color: var(--text-muted-color); /* Inactive icon color */
  }
  .nav-item .material-symbols-outlined {
    -webkit-user-select: none; /* Safari */
    -ms-user-select: none; /* IE 10+ and Edge */
    user-select: none; /* Standard syntax */
    font-size: 36px;
    transition: font-variation-settings 0.2s ease, color 0.2s ease;
    font-variation-settings: 'FILL' 0, 'wght' 200, 'GRAD' 0;
  }
  .nav-item.active {
    background-color: var(--accent-color);
    color: var(--text-on-accent-color); /* Active icon color */
  }
  #week-selector {
    width: 100%;
    padding: 15px 20px;
    background-color: var(--widget-color);
    color: var(--text-color);
    border: none;
    border-radius: var(--border-radius);
    font-size: 1.1rem;
    font-family: "TBCContractica", sans-serif;
    appearance: none;
    -webkit-appearance: none;
    cursor: pointer;
    font-weight: 600;
  }

  /* === WEEKS BAR (reimagined as dropdown) === */
  #weeks-bar-container {
    margin-bottom: 20px;
    position: relative;
  }

  .weeks-chooser {
    display: flex;
    gap: 12px;    
    width: 100%;
    overflow-x: auto;
    scrollbar-width: none;
    padding-bottom: 5px;
  }
  .weeks-chooser::-webkit-scrollbar { display: none; }

  .week-button {
    flex: 1;
    padding: 14px 5px 10px 5px;
    border-radius: 999px;
    background-color: var(--widget-color);
    color: var(--text-muted-color);
    border: 1px solid transparent;
    text-align: center;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
    font-size: 0.8rem;
    white-space: nowrap;
    font-family: "TBCContractica", sans-serif;
  }
  .week-button.is-current.active {
    color: var(--text-on-accent-color); /* Ensure text is white when it's the active current week */
  }

  .week-button:hover { background-color: color-mix(in srgb, var(--widget-color) 80%, white 20%); }
  .week-button.active { background-color: var(--accent-color); color: var(--text-on-accent-color); }
  .week-button.is-current { border: 1px solid var(--accent-color); color: var(--accent-color); }

  .empty-placeholder {
    text-align: center;
    color: var(--text-muted-color);
    padding: 40px;
    font-size: 1.1rem;
  }

  .weeks-mobile-nav {
    display: none; /* Hidden by default */
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    background-color: var(--widget-color);    
    border-radius: 999px; /* Full round edges */
    width: fit-content; /* Shrink to content */
    margin: 0 auto; /* Center horizontally */
    transition: background-color 0.2s ease;
  }

  .weeks-mobile-nav .nav-arrow {
    background: transparent;
    border: none;
    color: var(--text-color);
    cursor: pointer;
  }
   .weeks-mobile-nav .nav-arrow:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }
  .weeks-mobile-nav .current-week-display {
    font-weight: 600;
    font-size: 1rem;
    background-color: transparent; /* Neutral background by default */
    color: var(--text-color);
    padding: 5px 15px;
    border-radius: 999px;
    transition: background-color 0.2s ease, color 0.2s ease;
  }
  /* When the whole nav is the current week */
  .weeks-mobile-nav.is-current {
    background-color: var(--accent-color); /* Accent color for the current week */
  }
  .weeks-mobile-nav.is-current .current-week-display,
  .weeks-mobile-nav.is-current .nav-arrow {
    color: var(--text-on-accent-color);
    background-color: transparent; /* Ensure children are transparent */
  }

  @media screen and (max-width: 1000px) {
    body {
      padding: 100px 15px 120px 15px;
    }
    .widget-grid {
      grid-template-columns: 1fr;
    }
    #home-grid, #resources-grid {
      grid-template-rows: none; /* Remove fixed rows for mobile */
      grid-template-columns: 1fr; /* Ensure single column layout */
    }

    #home-grid, #resources-grid, #settings-grid {
      height: auto; /* Allow grids to grow with content on mobile */
    }
    #live-time-card {
      display: none; /* Hide time widget on mobile */
    }
  }

  /* Hide weeks bar on all pages except home page */
  #weeks-bar-container {
    display: none;
  }
  body[data-active-view="live-view"] #weeks-bar-container {
    display: block;
    animation: fadeIn 0.3s ease-in-out;
  }

  @media screen and (max-width: 1000px) {
    .weeks-chooser {
      display: none; /* Hide desktop weeks bar on mobile */
    }
    #weeks-bar-container {
      position: fixed;
      top: 20px;
      left: 0;
      right: 0;
      z-index: 999;
    }
    .weeks-mobile-nav {
      display: flex; /* Show mobile weeks nav */
      width: 200px;
      padding: 6px 10px;
    }
    header h1 {
      font-size: 1.8rem;
    }
    .bottom-nav {
      bottom: 10px;
    }
    .nav-item {
      width: 50px;
      height: 50px;
    }
    /* On mobile, the weeks bar is always a flex container when visible */
    body[data-active-view="live-view"] #weeks-bar-container { 
      display: flex;
      justify-content: center;
      animation: fadeIn 0.3s ease-in-out;
    }
    /* Hide the desktop chooser and show the mobile one */
    body[data-active-view="live-view"] #weeks-bar-container .weeks-chooser {
      display: none;
    }
    body[data-active-view="live-view"] #weeks-bar-container .weeks-mobile-nav {
      display: flex !important;
    }
  }
</style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="login-overlay">
  <h1>Shemdeg</h1>
  <button id="signInBtn">
    <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google logo">
    Sign in with Google
  </button>
</div>

<!-- LOADER -->
<div id="loadingOverlay"><div class="spinner"></div><p>იტვირთება</p></div>

<!-- FULLSCREEN WEEK SELECTOR -->
<div id="week-selector-overlay">
  <div class="week-selector-grid"></div>
</div>

<header>
  <h1 id="page-title">მთავარი</h1>
</header>

<!-- MAIN CONTENT -->
<div class="main-content">
  <!-- The weeks bar is moved outside the views to prevent it from re-animating on view switch -->
  <div id="weeks-bar-container">
    <!-- Mobile weeks nav is pre-rendered to prevent layout shift -->
    <div class="weeks-mobile-nav" style="display: none;">
      <button class="nav-arrow" id="mobile-prev-week"><span class="material-symbols-outlined">arrow_back_ios</span></button>
      <div class="current-week-display"></div>
      <button class="nav-arrow" id="mobile-next-week"><span class="material-symbols-outlined">arrow_forward_ios</span></button>
    </div>
  </div>
  <!-- HOME VIEW -->
  <div id="live-view" class="view active">
    <div id="home-grid" class="widget-grid">
      <!-- Live Time and Subject cards will be rendered here by JS -->
    </div>
  </div>

  <!-- RESOURCES VIEW -->
  <div id="resources-view" class="view">
    <div id="resources-grid" class="widget-grid">
        <!-- Global resources will be rendered here by JS -->
    </div>
  </div>

  <!-- SETTINGS VIEW -->
  <div id="settings-view" class="view">
    <div id="settings-grid" class="widget-grid">
        <!-- Settings widgets will be rendered here by JS -->
    </div>
  </div>

</div>

<!-- BOTTOM NAVIGATION -->
<div class="bottom-nav">
  <div class="nav-item active" data-view="live-view" data-title="მთავარი">
    <span class="material-symbols-outlined">home</span>
  </div>
  <div class="nav-item" data-view="resources-view" data-title="რესურსები">
    <span class="material-symbols-outlined">widgets</span>
  </div>
  <div class="nav-item" data-view="settings-view" data-title="პარამეტრები">
    <span class="material-symbols-outlined">settings</span>
  </div>
</div>


<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* === UTILITIES === */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const el = (t, p = {}, kids = []) => {
  const e = document.createElement(t);
  Object.assign(e, p);
  kids.forEach(k => e.append(k));
  return e;
};

function setCookie(name, value, days) {
  let expires = "";
  if (days) {
    const date = new Date();
    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
    expires = "; expires=" + date.toUTCString();
  }
  document.cookie = name + "=" + (value || "") + expires + "; path=/";
}

function getCookie(name) {
  const nameEQ = name + "=";
  const ca = document.cookie.split(';');
  for (let i = 0; i < ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) === ' ') c = c.substring(1, c.length);
    if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
  }
  return null;
}

/* === MAIN APP SCRIPT === */
const overlay = $("#loadingOverlay");

fetch("https://raw.githubusercontent.com/WEEKGE/live/main/config.json")
  .then(r => r.json())
  .then(cfg => {
    firebase.initializeApp(cfg);
    startWeekge();
  })
  .catch(() => {
    overlay.innerHTML = "<h2 style='color:red;text-align:center;margin-top:30vh;'>⚠️ config.json ვერ ჩაიტვირთა.</h2>";
  });

function startWeekge() {
  const auth = firebase.auth(), db = firebase.firestore();
    let user = null, catalog = [], selected = [], cache = {}, weekDates = [], userDays = {}, userThemeName = null, lectureDuration = "03:00", mySubjectCarouselIndex = 0, quizCompletion = {};
  let currentWeekData = null, selectedWeekNumber = null;

  const daysOfWeek = ["ორშაბათი","სამშაბათი","ოთხშაბათი","ხუთშაბათი","პარასკევი","შაბათი"];

  const todayISO = () => new Date().toISOString().slice(0, 10);
  const isBetween = (d, s, e) => d >= s && d <= e;

  const SEMESTER_WEEKS = [
    {n:1,start1:"2025-09-22",end1:"2025-09-28",start2:"2026-03-02",end2:"2026-03-08"},
    {n:2,start1:"2025-09-29",end1:"2025-10-05",start2:"2026-03-09",end2:"2026-03-15"},
    {n:3,start1:"2025-10-06",end1:"2025-10-12",start2:"2026-03-16",end2:"2026-03-22"},
    {n:4,start1:"2025-10-13",end1:"2025-10-19",start2:"2026-03-23",end2:"2026-03-29"},
    {n:5,start1:"2025-10-20",end1:"2025-10-26",start2:"2026-03-30",end2:"2026-04-05"},
    {n:6,start1:"2025-10-27",end1:"2025-11-02",start2:"2026-04-06",end2:"2026-04-12"},
    {n:7,start1:"2025-11-03",end1:"2025-11-09",start2:"2026-04-20",end2:"2026-04-26"},
    {n:8,start1:"2025-11-10",end1:"2025-11-16",start2:"2026-04-27",end2:"2026-05-03"},
    {n:9,start1:"2025-11-17",end1:"2025-11-23",start2:"2026-05-04",end2:"2026-05-10"},
    {n:10,start1:"2025-11-24",end1:"2025-11-30",start2:"2026-05-11",end2:"2026-05-17"},
    {n:11,start1:"2025-12-01",end1:"2025-12-07",start2:"2026-05-18",end2:"2026-05-24"},
    {n:12,start1:"2025-12-08",end1:"2025-12-14",start2:"2026-05-25",end2:"2026-05-31"},
    {n:13,start1:"2025-12-15",end1:"2025-12-20",start2:"2026-06-01",end2:"2026-06-06"}
  ];

  const THEMES = {
    "Default": { bg: "#121212", widget: "#1E1E1E", text: "#fff", accent: "#fff", accentVariant: "#fff", textOnAccent: "#000000" },
    "Ocean": { bg: "#0F2027", widget: "#203A43", text: "#ffffff", accent: "#1488CC", accentVariant: "#2B32B2", textOnAccent: "#FFFFFF" },
    "Sunset": { bg: "#2C0A1E", widget: "#4F1C3A", text: "#ffffff", accent: "#FF8C61", accentVariant: "#C83C66", textOnAccent: "#000000" },
    "Forest": { bg: "#1A2922", widget: "#2E463A", text: "#ffffff", accent: "#56C271", accentVariant: "#237A41", textOnAccent: "#000000" },
    "Light": { bg: "#F7F7F7", widget: "#FFFFFF", text: "#000000", accent: "#000000", accentVariant: "#333333", textOnAccent: "#FFFFFF" },
  };

  function applyTheme(themeName) {
    const theme = THEMES[themeName] || THEMES["Default"];
    const root = document.documentElement;
    root.style.setProperty('--bg-color', theme.bg);
    root.style.setProperty('--widget-color', theme.widget);
    root.style.setProperty('--text-color', theme.text);
    root.style.setProperty('--accent-color', theme.accent);
    root.style.setProperty('--accent-variant-color', theme.accentVariant);
    root.style.setProperty('--text-on-accent-color', theme.textOnAccent);
    userThemeName = themeName;
  }

  async function saveTheme(themeName) { // This function is for theme only
    applyTheme(themeName);
    if (user) {
      await db.collection("users").doc(user.uid).set({ userThemeName: themeName }, { merge: true });
    }
    setCookie('userThemeName', themeName, 365);
  }

  async function saveQuizStatus(subjectId, weekNumber, isCompleted) {
    const key = `${subjectId}_${weekNumber}`;
    quizCompletion[key] = isCompleted;
    if (user) {
      await db.collection("users").doc(user.uid).set({ quizCompletion }, { merge: true });
    }
    setCookie('quizCompletion', JSON.stringify(quizCompletion), 365);
  }
  let saveTimeout;
  function autoSave() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(saveSettings, 1200); // Debounce saves by 1.2 seconds
  }

  async function saveSettings() { // This now handles subjects and duration
    if (user) {
      await db.collection("users").doc(user.uid).set({ 
        subjects: selected, 
        days: userDays,
        lectureDuration: lectureDuration
      }, { merge: true });
    }
    setCookie('selectedSubjects', JSON.stringify(selected), 365);
    setCookie('userDays', JSON.stringify(userDays), 365);
    setCookie('lectureDuration', lectureDuration, 365);

    // Re-render pages to reflect changes without a full reload
    renderHomePage();
    renderResourcesPage();
    console.log("Settings auto-saved.");
  }

  /* === AUTHENTICATION === */
  auth.onAuthStateChanged(async u => {
    user = u || null;
    try {
      const loginOverlay = $("#login-overlay");
      if (user) {
        loginOverlay.style.display = "none";
        await bootAfterLogin();
      } else {
        loginOverlay.style.display = "flex";
      }
    } catch (error) {
      console.error("Bootstrapping failed:", error);
      overlay.innerHTML = `<h2 style='color:red;text-align:center;margin-top:30vh;'>⚠️ აპლიკაციის ჩატვირთვა ვერ მოხერხდა.</h2><p style='color:var(--text-muted-color)'>${error.message}</p>`;
    } finally {
      // Always hide the main loader, regardless of success or failure
      overlay.classList.add("hidden");
    }
  });

  $("#signInBtn").onclick = async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      await auth.signInWithPopup(provider);
    } catch (err) {
      console.error("Sign-in error:", err);
      let userMessage = "Sign-in failed. Please try again.";
      if (err.code === 'auth/popup-closed-by-user') {
        // Don't show a harsh error if the user simply closed the window.
        return; 
      } else if (err.code === 'auth/popup-blocked') {
        userMessage = "Sign-in popup was blocked by the browser. Please allow popups for this site and try again.";
      } else {
        userMessage = `Sign-in failed: ${err.message}`;
      }
      alert(userMessage);
    }
  };

  /* === APP BOOTSTRAP === */
  async function bootAfterLogin() {
    await loadData();
    flattenWeeks();
    initCurrentWeek();
    
    renderWeeksBar();
    renderHomePage();
    renderResourcesPage();
    renderSettingsPage();
    
    initLiveTime();
    initSummaryWidget();
    initNavigation();
  }

  async function loadData() {
    // Load catalog
    const catalogSnap = await db.collection("subjects").get();
    catalog = catalogSnap.docs.map(d => ({ id: d.id, ...d.data() }));

    // Load user data
    let data = {};
    if (user) {
      const userSnap = await db.collection("users").doc(user.uid).get();
      data = userSnap.exists ? userSnap.data() : {};
    } else {
      // Fallback to cookies if not logged in
      data.subjects = JSON.parse(getCookie('selectedSubjects') || '[]');
      data.days = JSON.parse(getCookie('userDays') || '{}');
      data.userThemeName = getCookie('userThemeName') || "Default";
      data.lectureDuration = getCookie('lectureDuration') || "03:00";
      data.quizCompletion = JSON.parse(getCookie('quizCompletion') || '{}');
    }

    selected = data.subjects || [];
    userDays = data.days || {};
    userThemeName = data.userThemeName || "Default";
    applyTheme(userThemeName);

    quizCompletion = data.quizCompletion || {};
    lectureDuration = data.lectureDuration || "03:00";
    // Ensure subjects are in cache
    const toLoad = selected.filter(id => !cache[id]);
    for (const id of toLoad) {
      const subj = catalog.find(c => c.id === id);
      if (subj) cache[id] = subj;
    }
  }

  function flattenWeeks() {
    weekDates = [];
    SEMESTER_WEEKS.forEach(w => {
      if (w.start1) weekDates.push({ n: w.n, start: w.start1, end: w.end1 });
      if (w.start2) weekDates.push({ n: w.n, start: w.start2, end: w.end2 });
    });
  }

  function initCurrentWeek() {
    const iso = todayISO();
    currentWeekData = weekDates.find(w => isBetween(iso, w.start, w.end)) || weekDates[0];
    selectedWeekNumber = currentWeekData ? currentWeekData.n : (weekDates.length > 0 ? weekDates[0].n : 1);
  }

  /* === NAVIGATION === */
  function initNavigation() {
    const navItems = $$('.nav-item');
    const views = $$('.view');
    const pageTitle = $('#page-title');

    // Set the initial active view on the body for correct CSS targeting on startup
    document.body.dataset.activeView = 'live-view';

    navItems.forEach(item => {
      item.addEventListener('click', () => {
        const viewId = item.dataset.view;
        
        navItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');

        views.forEach(v => v.classList.remove('active'));
        $(`#${viewId}`).classList.add('active');

        pageTitle.textContent = item.dataset.title;

        // Set a data-attribute on the body for more flexible CSS targeting
        document.body.dataset.activeView = viewId;
      });
    });
  }

  /* === LIVE TIME WIDGET === */
  function initLiveTime() {
    const timeEl = el('div', { className: 'time' });
    const dateEl = el('div', { className: 'date' });
    const timeCard = el('div', { id: 'live-time-card', className: 'widget-card' }, [timeEl, dateEl]);

    $('#home-grid').prepend(timeCard);

    function updateTime() {
      const now = new Date();
      timeEl.textContent = now.toLocaleTimeString('ka-GE', { hour: '2-digit', minute: '2-digit' });
      dateEl.textContent = now.toLocaleDateString('ka-GE', { weekday: 'long', month: 'long', day: 'numeric' });
    }
    updateTime();
    setInterval(updateTime, 1000);
  }

  function initSummaryWidget() {
    // Remove old widgets if they exist
    $('#weeks-left-card')?.remove();
    $('#quiz-counter-card')?.remove();
    $('#summary-widget')?.remove();

    // 1. Weeks until exams
    const lastWeekNumber = SEMESTER_WEEKS[SEMESTER_WEEKS.length - 1].n;
    const weeksLeft = (!currentWeekData || currentWeekData.n > lastWeekNumber) ? 0 : (lastWeekNumber - currentWeekData.n) + 1;

    // 2. Quiz stats
    const completedQuizzes = Object.values(quizCompletion).filter(Boolean).length;
    let totalQuizzes = 0;
    let missedQuizzes = 0;
    const now = new Date();
    const [hours, minutes] = lectureDuration.split(':').map(Number);
    const lectureDurationMs = (hours * 60 * 60 * 1000) + (minutes * 60 * 1000);
    
    selected.forEach(subjId => {
      const subj = cache[subjId];
      if (subj && subj.weeks) {
        subj.weeks.forEach(week => {
          if (week.type === 'ლექცია (ქვიზი)' || week.type === 'შუალედური' || week.type === 'პრეზენტაცია') {
            totalQuizzes++;

            const quizKey = `${subjId}_${week.week + 1}`;
            const isCompleted = quizCompletion[quizKey] === true;

            // Check if missed
            const weekInfo = weekDates.find(wd => wd.n === (week.week + 1));
            if (!isCompleted && weekInfo && weekInfo.end < todayISO()) {
                missedQuizzes++;
            }
          }
        });
      }
    });
    const remainingQuizzes = totalQuizzes - completedQuizzes;

    // --- Create Widget ---
    const createStatItem = (label, value, valueStyle = {}) => {
        const valueEl = el('div', { className: 'summary-value', textContent: value });
        Object.assign(valueEl.style, valueStyle);
        return el('div', { className: 'summary-item' }, [
            valueEl,
            el('div', { className: 'summary-label', textContent: label })
        ]);
    };

    const completedStyle = { color: '#4fff38' }; // Green
    const missedStyle = missedQuizzes > 0 ? { color: '#ff3c2e' } : {}; // Red if > 0

    const summaryCard = el('div', { 
        id: 'summary-widget', 
        className: 'widget-card' 
    }, [
        createStatItem('კვირა გამოცდამდე', weeksLeft),
        createStatItem('ჩაბარებული ქვიზი', completedQuizzes, completedStyle),
        createStatItem('ჩასაბარებელი ქვიზი', remainingQuizzes, {}),
        createStatItem('გამოტოვებული ქვიზი', missedQuizzes, missedStyle)
    ]);

    // summaryCard.style.gap = '10px'; // This is now handled by CSS

    $('#live-time-card').after(summaryCard);
  }

  /* === WEEKS BAR / SELECTOR === */
  function renderWeeksBar() {
    const container = $('#weeks-bar-container');
    container.innerHTML = ''; // Clear previous content

    // --- Desktop Weeks Bar (Horizontal List) ---
    const chooser = el('div', { className: 'weeks-chooser' });
    SEMESTER_WEEKS.forEach(week => {
      const btn = el('button', { className: 'week-button', textContent: `კვირა ${week.n}` });
      if (week.n === selectedWeekNumber) btn.classList.add('active');
      if (currentWeekData && week.n === currentWeekData.n) btn.classList.add('is-current');
      btn.onclick = () => {
        selectedWeekNumber = week.n;
        renderHomePage();
        renderWeeksBar(); // Re-render to update active state
      };
      chooser.append(btn);
    });
    container.append(chooser);

    // --- Pre-render Mobile Navigator and append it ---
    const mobileNavTemplate = `
      <div class="weeks-mobile-nav" style="display: none;">
        <button class="nav-arrow" id="mobile-prev-week"><span class="material-symbols-outlined">arrow_back_ios</span></button>
        <div class="current-week-display"></div>
        <button class="nav-arrow" id="mobile-next-week"><span class="material-symbols-outlined">arrow_forward_ios</span></button>
      </div>`;
    container.insertAdjacentHTML('beforeend', mobileNavTemplate);

    // --- Fullscreen Overlay Logic ---
    const weekSelectorOverlay = $('#week-selector-overlay');
    const weekSelectorGrid = $('.week-selector-grid');
    weekSelectorOverlay.onclick = (e) => { if (e.target === weekSelectorOverlay) weekSelectorOverlay.classList.remove('visible'); };

    // --- Mobile Navigator ---
    const prevWeek = () => {
        const currentIndex = SEMESTER_WEEKS.findIndex(w => w.n === selectedWeekNumber);
        if (currentIndex > 0) {
            selectedWeekNumber = SEMESTER_WEEKS[currentIndex - 1].n;
            renderHomePage();
            renderWeeksBar();
        }
    };
    const nextWeek = () => {
        const currentIndex = SEMESTER_WEEKS.findIndex(w => w.n === selectedWeekNumber);
        if (currentIndex < SEMESTER_WEEKS.length - 1) {
            selectedWeekNumber = SEMESTER_WEEKS[currentIndex + 1].n;
            renderHomePage();
            renderWeeksBar();
        }
    };

    // --- Update Pre-rendered Mobile Navigator ---
    const mobileNav = $('.weeks-mobile-nav');
    const weekDisplay = $('.current-week-display');
    const prevBtn = $('#mobile-prev-week');
    const nextBtn = $('#mobile-next-week');

    weekDisplay.textContent = `კვირა ${selectedWeekNumber}`;
    mobileNav.classList.remove('is-current'); // Reset class
    if (currentWeekData && selectedWeekNumber === currentWeekData.n) {
      mobileNav.classList.add('is-current');
    }
    prevBtn.onclick = prevWeek;
    nextBtn.onclick = nextWeek;
    prevBtn.disabled = selectedWeekNumber === 1;
    nextBtn.disabled = selectedWeekNumber === SEMESTER_WEEKS.length;
  }

  /* === RENDERING FUNCTIONS === */

  function isSubjectEnded(subject, currentTime, durationMs) {
    if (!subject.time || subject.dayIndex === -1 || subject.dayIndex === undefined) return false;

    const nowDayIndex = currentTime.getDay() === 0 ? 6 : currentTime.getDay() - 1;

    if (subject.dayIndex > nowDayIndex) {
        return false; // Subject is on a future day of the week
    }

    const [hour, minute] = subject.time.split(':').map(Number);

    // Create a date object for the subject's lecture this week
    const subjectDate = new Date(currentTime);
    const dayDifference = subject.dayIndex - nowDayIndex;
    subjectDate.setDate(subjectDate.getDate() + dayDifference);
    subjectDate.setHours(hour, minute, 0, 0);

    const subjectEnd = new Date(subjectDate.getTime() + durationMs);

    return currentTime > subjectEnd;
  }

  function sortByWeekdayTimeAndStatus(subjs, selectedWeekNumber, currentWeekData, lectureDuration) {
    const now = new Date();
    const [hours, minutes] = lectureDuration.split(':').map(Number);
    const lectureDurationMs = (hours * 60 * 60 * 1000) + (minutes * 60 * 1000);

    const isSelectedWeekCurrent = currentWeekData && (selectedWeekNumber === currentWeekData.n);

    return subjs.sort((a, b) => {
      // For the current week, sort by "ended" status first.
      if (isSelectedWeekCurrent) {
        const isEndedA = isSubjectEnded(a, now, lectureDurationMs);
        const isEndedB = isSubjectEnded(b, now, lectureDurationMs);
        if (isEndedA !== isEndedB) {
          return isEndedA ? 1 : -1; // Ended subjects go to the bottom.
        }
      }

      // For all weeks (or for subjects with the same "ended" status on the current week),
      // sort by day, then time.
      if (a.dayIndex !== b.dayIndex) return a.dayIndex - b.dayIndex;
      if (a.time && b.time) return a.time.localeCompare(b.time);
      return a.name.localeCompare(b.name); // Fallback to name sort.
    });
  }

  function getEmbedIcon(type) {
    switch (type?.toLowerCase()) {
      case 'slide': return 'slideshow';
      case 'video': return 'play_circle';
      case 'book': return 'menu_book';
      default: return 'link';
    }
  }

  function createEmbedLinks(buttons) {
    const container = el('div', { className: 'embed-links' });
    if (!buttons || buttons.length === 0) return container;

    buttons.forEach(b => {
      const isCustom = b.type === 'custom';
      const iconCircleClass = isCustom ? 'icon-circle is-custom' : 'icon-circle';
      const linkClass = isCustom ? 'embed-link is-custom' : 'embed-link';

      const link = el('a', { className: linkClass, href: b.link || '#', target: '_blank', title: b.label }, [
        el('div', { className: iconCircleClass }, [
          el('span', { className: 'material-symbols-outlined', textContent: getEmbedIcon(b.type) }),
          ...(isCustom ? [el('span', { className: 'label', textContent: b.label, style: 'white-space: nowrap;' })] : []) ]) ]);
      container.append(link);
    });
    return container;
  }

  function renderHomePage() {
    const grid = $('#home-grid');
    // Clear only subject cards, not the time widget
    $$('#home-grid .subject-card').forEach(card => card.remove());

    const now = new Date();
    const todayDayIndex = now.getDay() === 0 ? 6 : now.getDay() - 1;

    const subjectsForWeek = selected.map(id => {
        const subj = cache[id];
        if (!subj) return null;

        const dayData = userDays?.[id] ?? { day: null, time: null };
        const dayIndex = daysOfWeek.indexOf(dayData.day);

        // --- LOGIC from indexold.html: Determine which week's content to show ---
        let weekContentToShow = selectedWeekNumber;
        const isCurrentWeekSelected = currentWeekData && selectedWeekNumber === currentWeekData.n;
        let isUpcomingForContent = false;

        // If it's the current week and the lecture has passed, show the current week's topic.
        // Otherwise (if lecture is upcoming), show the previous week's topic.
        if (isCurrentWeekSelected && dayIndex !== -1 && dayData.time) {
            const [hours, minutes] = lectureDuration.split(':').map(Number);
            const lectureDurationMs = (hours * 60 * 60 * 1000) + (minutes * 60 * 1000);
            const ended = isSubjectEnded({ dayIndex, time: dayData.time }, now, lectureDurationMs);
            
            if (!ended && weekContentToShow > 1) { // If not ended (upcoming), show previous week
                weekContentToShow = selectedWeekNumber - 1;
                isUpcomingForContent = true;
            } 
        }

        const weekData = subj.weeks?.find(w => w.week === weekContentToShow) || {};
        return {
            ...subj,
            weekTopic: weekData.topic || '<i>თემა არ არის მითითებული</i>',
            weekType: weekData.type,
            weekButtons: weekData.buttons,
            dayIndex: dayIndex,
            time: dayData.time,
            isScheduled: dayIndex !== -1,
            isUpcomingForContent: isUpcomingForContent // Pass this flag
        };
    }).filter(Boolean);

    const sortedSubjects = sortByWeekdayTimeAndStatus(subjectsForWeek, selectedWeekNumber, currentWeekData, lectureDuration);

    if (subjectsForWeek.length === 0) {
        if (!$('.empty-placeholder')) {
            grid.append(el('p', {className: 'empty-placeholder', textContent: 'საგნები არ არის არჩეული. დაამატე პარამეტრებიდან.'}));
        }
        return;
    } else {
        const placeholder = $('.empty-placeholder');
        if (placeholder) placeholder.remove();
    }

    sortedSubjects.forEach(subj => {
      let isUpcoming = false;
      const isSelectedWeekCurrent = currentWeekData && selectedWeekNumber === currentWeekData.n;
      const isSelectedWeekFuture = currentWeekData && selectedWeekNumber > currentWeekData.n;

      // A subject is "upcoming" if it's in a future week,
      // or if it's in the current week and its content is being shown from the previous week (meaning the lecture hasn't happened yet).
      if (isSelectedWeekFuture || (isSelectedWeekCurrent && subj.isUpcomingForContent)) {
          isUpcoming = true;
      }

      const cardClasses = ['widget-card', 'subject-card'];
      if (isUpcoming) {
        // The animation is applied via the is-upcoming class in CSS
        cardClasses.push('is-upcoming');
      }

      const titleEl = el('h3', { className: 'widget-title', textContent: subj.name });
      if (subj.icon) {
        titleEl.style.display = 'flex';
        titleEl.style.alignItems = 'center';
        titleEl.style.gap = '10px';
        titleEl.prepend(el('span', { className: 'material-symbols-outlined', textContent: subj.icon, style: 'color: var(--text-muted-color);' }));
      }

      const embedLinksContainer = createEmbedLinks(subj.weekButtons);

      // Check for quiz and add button to the embed links container
      if (subj.weekType === 'ლექცია (ქვიზი)' || subj.weekType === 'შუალედური' || subj.weekType === 'პრეზენტაცია') {
        const quizKey = `${subj.id}_${selectedWeekNumber}`;
        const isChecked = quizCompletion[quizKey] === true;
        const isPastWeek = currentWeekData && selectedWeekNumber < currentWeekData.n;

        const quizCheckButton = el('button', { className: 'quiz-check-btn', title: 'ქვიზი დაწერილია' });
        if (isChecked) {
          quizCheckButton.classList.add('checked');
        } else if (isPastWeek) {
          quizCheckButton.classList.add('is-missed');
          quizCheckButton.title = 'ქვიზი გამოტოვებულია';
        }

        quizCheckButton.append(el('span', { className: 'material-symbols-outlined', textContent: 'check' }));

        quizCheckButton.onclick = (e) => {
          // If it was a missed button, remove the 'is-missed' class so the 'checked' style can apply correctly.
          if (quizCheckButton.classList.contains('is-missed')) {
            quizCheckButton.classList.remove('is-missed');
          }
          const newState = quizCheckButton.classList.toggle('checked');
          saveQuizStatus(subj.id, selectedWeekNumber, newState);
          initSummaryWidget(); // Update summary widget on click
        };
        embedLinksContainer.append(quizCheckButton);
      }

      const subtitleEl = el('p', { className: 'widget-subtitle' });

      if (subj.weekType === 'პრეზენტაცია' || subj.weekType === 'შუალედური') {
        subtitleEl.textContent = subj.weekType;
        subtitleEl.style.color = 'var(--accent-color)';
        subtitleEl.style.fontWeight = '700';
      } else if (subj.weekType === 'ლექცია (ქვიზი)') {
        subtitleEl.innerHTML = `ლექცია (<b style="color: var(--accent-color); font-weight: 700;">ქვიზი</b>)`;
      } else {
        subtitleEl.textContent = subj.weekType || 'ლექცია';
      }

      const card = el('div', { className: cardClasses.join(' ') }, [
        titleEl,
        subtitleEl,
        el('div', { className: 'topic', innerHTML: subj.weekTopic }),
        embedLinksContainer
      ]);
      grid.append(card);
      card.style.animation = 'widget-fade-in 0.4s ease-out both';
    });
  }

  function renderResourcesPage() {
    const grid = $('#resources-grid');
    grid.innerHTML = '';

    const todayDayIndex = new Date().getDay() === 0 ? 6 : new Date().getDay() - 1;

    const subjectsWithGlobalButtons = selected.map(id => {
        const subj = cache[id];
        if (!subj || !subj.globalButtons || subj.globalButtons.length === 0) return null;

        const dayData = userDays?.[id] ?? { day: null, time: null };

        return {
            ...subj,
            dayIndex: daysOfWeek.indexOf(dayData.day),
            time: dayData.time,
            isScheduled: dayData.day !== null
        };
    }).filter(Boolean);

    // Sort subjects: scheduled first, then by upcoming, day, time, and name.
    subjectsWithGlobalButtons.sort((a, b) => {
        const aScheduled = a.dayIndex > -1;
        const bScheduled = b.dayIndex > -1;

        if (aScheduled && !bScheduled) return -1;
        if (!aScheduled && bScheduled) return 1;
        if (!aScheduled && !bScheduled) return a.name.localeCompare(b.name);

        // Both are scheduled
        const isAUpcoming = a.dayIndex >= todayDayIndex;
        const isBUpcoming = b.dayIndex >= todayDayIndex;

        if (isAUpcoming !== isBUpcoming) return isAUpcoming ? -1 : 1;

        if (a.dayIndex !== b.dayIndex) return a.dayIndex - b.dayIndex;

        if (a.time && b.time) return a.time.localeCompare(b.time);
        
        return a.name.localeCompare(b.name); // final fallback
    });

    if (subjectsWithGlobalButtons.length === 0) {
        grid.append(el('p', {className: 'empty-placeholder', textContent: 'არჩეულ საგნებს არ აქვს გლობალური რესურსები.'}));
        return;
    }

    subjectsWithGlobalButtons.forEach(subj => {
      const titleEl = el('h3', { className: 'widget-title', textContent: subj.name });
      if (subj.icon) {
        titleEl.style.display = 'flex';
        titleEl.style.alignItems = 'center';
        titleEl.style.gap = '10px';
        titleEl.prepend(el('span', { className: 'material-symbols-outlined', textContent: subj.icon, style: 'color: var(--text-muted-color);' }));
      }
      const card = el('div', { className: 'widget-card' }, [
        titleEl,
        createEmbedLinks(subj.globalButtons)
      ]);
      grid.append(card);
    });
  }

  function renderSettingsPage() {
    const grid = $('#settings-grid');
    grid.innerHTML = '';

    // Create containers for the layout
    const mySubjectsColumn = el('div', { className: 'settings-column' });
    const catalogColumn = el('div', { className: 'settings-column' });
    const sideColumn = el('div', { className: 'settings-column' });

    // -- My Subjects Carousel (no widget container) --
    const sortedSelected = selected.map(id => cache[id]).filter(Boolean).sort((a, b) => a.name.localeCompare(b.name));
    const carouselContent = el('div', { className: 'subject-carousel-content' });

    // Clamp index if a subject was removed
    if (mySubjectCarouselIndex >= sortedSelected.length) {
      mySubjectCarouselIndex = Math.max(0, sortedSelected.length - 1);
    }

    if (sortedSelected.length > 0) {
      const currentSubject = sortedSelected[mySubjectCarouselIndex];
      carouselContent.append(createMySubjectWidget(currentSubject, sortedSelected));
    } else {
      carouselContent.append(el('p', {className: 'empty-placeholder', style: 'padding: 20px;', textContent: 'საგნები არ არის არჩეული.'}));
    }

    const prevBtn = el('button', { className: 'subject-carousel-nav-btn', disabled: sortedSelected.length < 2 }, [el('span', {className: 'material-symbols-outlined', textContent: 'arrow_back_ios_new'})]);
    const nextBtn = el('button', { className: 'subject-carousel-nav-btn', disabled: sortedSelected.length < 2 }, [el('span', {className: 'material-symbols-outlined', textContent: 'arrow_forward_ios'})]);

    prevBtn.onclick = () => {
      mySubjectCarouselIndex = (mySubjectCarouselIndex - 1 + sortedSelected.length) % sortedSelected.length;
      renderSettingsPage();
    };
    nextBtn.onclick = () => {
      mySubjectCarouselIndex = (mySubjectCarouselIndex + 1) % sortedSelected.length;
      renderSettingsPage();
    };

    // The nav buttons are now appended inside createMySubjectWidget
    const navButtonsContainer = el('div', { className: 'subject-carousel-nav-container' }, [prevBtn, nextBtn]);    

    // -- Subjects Catalog Widget --
    const searchInput = el('input', { id: 'catalog-search', type: 'search', placeholder: 'საგნის მოძებნა...' });
    const searchContainer = el('div', { className: 'search-input-container' }, [
        el('span', { className: 'material-symbols-outlined', textContent: 'search' }),
        searchInput
    ]);

    const catalogContent = el('div', { className: 'settings-widget-content', style: 'padding-right: 0;' });
    
    const renderCatalogItems = (filter = '') => {
        catalogContent.innerHTML = '';
        let subjectsToShow;

        if (filter) {
            // If searching, filter the whole sorted catalog
            const sortedCatalog = [...catalog].sort((a, b) => a.name.localeCompare(b.name));
            subjectsToShow = sortedCatalog.filter(subj => subj.name.toLowerCase().includes(filter.toLowerCase()));
        } else {
            // If not searching, show up to 5 random subjects
            const shuffled = [...catalog].sort(() => 0.5 - Math.random());
            subjectsToShow = shuffled.slice(0, 5);
        }

        subjectsToShow.forEach(subj => {
            const isAdded = selected.includes(subj.id);
            let button;

            if (isAdded) {
                button = el('button', { className: 'action-btn added', disabled: true }, [ el('span', { className: 'material-symbols-outlined', textContent: 'check' }) ]);
            } else {
                button = el('button', { className: 'action-btn' }, [ el('span', { className: 'material-symbols-outlined', textContent: 'add' }) ]);
                button.onclick = () => { 
                    selected.push(subj.id); 
                    // Set default day and time on add
                    userDays[subj.id] = { day: daysOfWeek[0], time: "09:00" };
                    autoSave(); renderSettingsPage(); 
                };
            }
            catalogContent.append(el('div', { className: 'settings-item' }, [ el('div', { className: 'name', textContent: subj.name }), button ]));
        });
    };

    searchInput.oninput = () => renderCatalogItems(searchInput.value);
    renderCatalogItems(); // Initial render

    const catalogCard = el('div', { id: 'catalog-widget', className: 'widget-card', style: 'flex: 1; min-height: 0;' }, [
      el('h3', { className: 'widget-title', textContent: 'საგნების კატალოგი' }),
      searchContainer,
      catalogContent
    ]);

    // Append carousel content to its column
    mySubjectsColumn.append(carouselContent);

    catalogColumn.append(catalogCard);

    // -- Lecture Duration Widget --
    const durationCard = createDurationWidget();
    sideColumn.append(durationCard);

    // -- Theme Selector Widget --
    const themeCard = createThemeWidget();
    sideColumn.append(themeCard);

    // -- Logout Widget --
    const logoutCard = createLogoutWidget();
    sideColumn.append(logoutCard);

    grid.append(mySubjectsColumn, catalogColumn, sideColumn);    
  }

  function createMySubjectWidget(subj, sortedSelected) {
      const lectureStartTimes = ["09:00", "11:20", "13:40", "16:00", "18:20"].sort();
      const dayAbbreviations = ["ორშ", "სამ", "ოთხ", "ხუთ", "პარ", "შაბ"];
      const currentDay = userDays[subj.id]?.day;

      const timeSelect = el('select', { className: 'day-time-select' });
      lectureStartTimes.forEach(time => {
        const opt = el('option', { value: time, textContent: time });
        if (userDays[subj.id]?.time === time) opt.selected = true;
        timeSelect.append(opt);
      });
      timeSelect.onchange = () => {
        if (!userDays[subj.id]) userDays[subj.id] = { day: null, time: null };
        userDays[subj.id].time = timeSelect.value;
        autoSave();
      };

      const weekdayContainer = el('div', { className: 'weekday-chooser' });
      daysOfWeek.forEach((day, index) => {
        const dayBtn = el('button', {
          className: 'weekday-btn',
          textContent: dayAbbreviations[index],
          title: day
        });
        if (currentDay === day) {
          dayBtn.classList.add('active');
        }
        dayBtn.onclick = () => {
          if (!userDays[subj.id]) userDays[subj.id] = { day: null, time: null };

          // Only allow changing to a different day, not deselecting.
          if (userDays[subj.id].day !== day) {
            userDays[subj.id].day = day;
            autoSave();
            renderSettingsPage(); // Re-render to show active state change
          }
        };
        weekdayContainer.append(dayBtn);
      });

      const removeBtn = el('button', { className: 'action-btn remove' }, [
        el('span', { className: 'material-symbols-outlined', textContent: 'close' })
      ]);
      removeBtn.onclick = () => {
        selected = selected.filter(id => id !== subj.id);
        delete userDays[subj.id];
        // mySubjectCarouselIndex will be auto-clamped on re-render
        autoSave();
        renderSettingsPage();
      };

      const controls = el('div', { style: 'display: flex; flex-direction: column; gap: 10px; flex-grow: 1;'}, [
        el('h3', { className: 'widget-title', textContent: subj.name, style: 'font-size: 1.1rem; margin-bottom: 5px;' }),
        weekdayContainer,
        timeSelect,
      ]);

      // Create nav buttons here to append them inside the widget
      const prevBtn = el('button', { className: 'subject-carousel-nav-btn' }, [el('span', {className: 'material-symbols-outlined', textContent: 'arrow_back_ios_new'})]);
      const nextBtn = el('button', { className: 'subject-carousel-nav-btn' }, [el('span', {className: 'material-symbols-outlined', textContent: 'arrow_forward_ios'})]);

      prevBtn.onclick = () => {
        mySubjectCarouselIndex = (mySubjectCarouselIndex - 1 + sortedSelected.length) % sortedSelected.length;
        renderSettingsPage();
      };
      nextBtn.onclick = () => {
        mySubjectCarouselIndex = (mySubjectCarouselIndex + 1) % sortedSelected.length;
        renderSettingsPage();
      };

      const navContainer = el('div', { className: 'subject-carousel-nav-container' }, [prevBtn, nextBtn]);

      // This is now an item within a widget, not a full widget-card itself.
      return el('div', { className: 'settings-item', style: 'flex-direction: column; align-items: stretch; padding: 15px; background: color-mix(in srgb, var(--text-color) 3%, transparent); border-radius: 12px; gap: 15px; border-bottom: none; flex-grow: 1; display: flex;' }, [
          el('div', {style: 'display: flex; justify-content: space-between; align-items: flex-start;'}, [
            el('h3', { className: 'widget-title', textContent: subj.name, style: 'font-size: 1.1rem;' }),
          removeBtn,
          ]),
          weekdayContainer,
          timeSelect,
          navContainer // Add the navigation container here
      ]);
  }

  function createDurationWidget() {
    const [initialHour, initialMinute] = lectureDuration.split(':');

    const hourSelect = el('select', { className: 'day-time-select' });
    for (let i = 0; i <= 4; i++) {
      hourSelect.append(el('option', { value: i, textContent: `${i} სთ`, selected: i == initialHour }));
    }

    const minuteSelect = el('select', { className: 'day-time-select' });
    for (let i = 0; i <= 55; i += 5) {
      minuteSelect.append(el('option', { value: i, textContent: `${i} წთ`, selected: i == initialMinute }));
    }

    const updateDuration = () => {
      lectureDuration = `${hourSelect.value}:${minuteSelect.value}`;
      autoSave();
    };
    hourSelect.onchange = updateDuration;
    minuteSelect.onchange = updateDuration;

    const container = el('div', { className: 'duration-selector', style: 'display: flex; gap: 10px; margin-top: 10px;' }, [hourSelect, minuteSelect]);
    return el('div', { className: 'widget-card' }, [
      el('h3', { className: 'widget-title', textContent: 'ლექციის ხანგრძლივობა' }),
      container
    ]);
  }

  function createThemeWidget() {
    // Theme Selector Widget
    const themeOptions = Object.keys(THEMES).map(themeName => {
        const theme = THEMES[themeName];
        const option = el('div', { className: 'theme-option', style: 'cursor: pointer;' }, [
            el('div', { className: 'name', textContent: themeName }),
            el('div', { className: 'swatches' }, [
                el('div', { className: 'swatch', style: `background-color: ${theme.bg}` }),
                el('div', { className: 'swatch', style: `background-color: ${theme.widget}` }),
                el('div', { className: 'swatch', style: `background-color: ${theme.accent}` }),
            ])
        ]);
        if (themeName === userThemeName) {
            option.classList.add('active');
        }
        option.onclick = () => {
            saveTheme(themeName);
            // Re-render to show active state
            renderSettingsPage();
        };
        return option;
    });

    return el('div', { className: 'widget-card theme-selector' }, [
      el('h3', { className: 'widget-title', textContent: 'თემის არჩევა' }),
      el('div', { className: 'themes' }, themeOptions)
    ]);
  }

  function createLogoutWidget() {

    // Logout Widget
    const logoutButton = el('button', {
        className: 'logout-button',
        textContent: 'გასვლა'
    });
    logoutButton.onclick = async () => {
        try {
            await auth.signOut();
            location.reload();
        } catch (error) {
            console.error("Error signing out:", error);
        }
    };
    return el('div', { className: 'widget-card' }, [logoutButton]);
  }

  function markDirty() {
    // This function is no longer needed with auto-save.
  }
}
</script>
</body>
</html>