<!DOCTYPE html>
<html lang="ka">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Shemdeg</title>

<meta name="description" content="shemdeg.github.io">
<meta name="theme-color" content="#0B1216">
<meta name="apple-mobile-web-app-capable" content="yes" /> 
<link rel="icon" href="/icons/shicon.png">


<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wdth,wght@62.5..100,100..900&display=swap" rel="stylesheet">

<style>
  :root {
    --bg-color: #121212;
    --widget-color: #1E1E1E;
    --text-color: #E0E0E0;
    --text-muted-color: #8A8A8A;
    --accent-color: #BB86FC;
    --accent-variant-color: #3700B3;
    --text-on-accent-color: #000000;
    --border-radius: 16px;
    --font-family: "Noto Sans Georgian", sans-serif;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html {
    color-scheme: dark;
  }

  body {
    background-color: var(--bg-color);
    color: var(--text-color);
    font-family: var(--font-family);
    padding: 20px 20px 120px 20px; /* Padding for content, space for bottom nav */
  }

  /* === LOADER === */
  #loadingOverlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: var(--bg-color); display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    transition: opacity .3s ease, visibility .3s ease;
  }
  #loadingOverlay.hidden { opacity: 0; visibility: hidden; }
  #loadingOverlay .spinner {
    width: 80px; height: 80px; border: 8px solid rgba(255,255,255,0.1);
    border-top: 8px solid var(--accent-color); border-radius: 50%;
    animation: spin 0.5s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  #loadingOverlay p { margin-top: 20px; font-size: 1.1rem; color: var(--text-muted-color); }

  /* === LOGIN OVERLAY === */
  #login-overlay {
    display: none; position: fixed; inset: 0; background: var(--bg-color); z-index: 10000; 
    flex-direction: column; align-items: center; justify-content: center; gap: 20px;
  }
  #login-overlay h1 { font-size: 3rem; color: var(--accent-color); }
  #signInBtn {
    background: #fff; color: #000; border: none; padding: 12px 24px; font-size: 1.1rem; 
    cursor: pointer; display: flex; align-items: center; gap: 12px; border-radius: 8px;
  }
  #signInBtn img { height: 24px; }

  /* === HEADER === */
  header {
    padding: 0 10px 20px 10px;
    display: none; /* Hide header as requested */
  }
  header h1 {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-color);
  }


  .view {
    display: none;
    animation: fadeIn 0.3s ease-in-out;
  }
  .view.active {
    display: block;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* === WIDGET GRID SYSTEM (Base) === */
  .widget-grid {
    display: grid;    
    gap: 20px;
  }
  
  /* === VIEW-SPECIFIC GRID STYLES === */
  #home-grid {
    grid-template-columns: repeat(5, 1fr);
  }

  #resources-grid {
    grid-template-columns: repeat(5, 1fr);
  }

  /* === WIDGET CARD STYLING === */
  .widget-card {
    background-color: var(--widget-color);
    border-radius: var(--border-radius);
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    transition: box-shadow 0.2s ease;
    overflow: hidden; /* Prevent content from spilling out of the card */
  }
  .widget-card:hover {
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
  }

  .widget-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-color);
  }
  .widget-subtitle {
    font-size: 0.9rem;
    color: var(--text-muted-color);
    margin-top: -10px;
  }

  /* === HOME PAGE WIDGETS === */
  #live-time-card {
    text-align: center;
    justify-content: center;
  }
  #live-time-card .time {
    font-size: 3.5rem;
    font-weight: 700;
  }
  #live-time-card .date {
    font-size: 1.2rem;
    color: var(--text-muted-color);
  }

  .subject-card.is-upcoming {
    background-color: color-mix(in srgb, var(--accent-color) 8%, var(--widget-color));
    border: 1px solid color-mix(in srgb, var(--accent-color) 20%, transparent);
  }

  .subject-card .topic {
    font-size: 1rem;
    line-height: 1.5;
    color: var(--text-muted-color);    
    white-space: nowrap; /* Keep text on a single line */
    text-overflow: ellipsis; /* Add ... for overflow */
    overflow: hidden;
  }
  .subject-card .embed-links {
    display: flex;
    gap: 15px;
    margin-top: auto; /* Pushes to bottom */
    padding-top: 10px;
  }
  .embed-link {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    color: var(--text-muted-color);
    transition: color 0.2s ease;
  }
  .embed-link.is-custom {
    flex-direction: row; /* For custom links, align horizontally */
  }
  .embed-link:hover {
    color: var(--accent-color);
  }
  .embed-link .icon-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: rgba(255,255,255,0.05);
    display: grid;
    place-items: center;
    transition: background-color 0.2s ease;
  }
  .embed-link .icon-circle.is-custom {
    width: auto; /* Auto-width for custom links */
    border-radius: 25px; /* Pill shape */
    padding: 0 24px 0 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .embed-link:hover .icon-circle {
    background-color: var(--accent-variant-color);
  }
  .embed-link .icon-circle .material-symbols-outlined {
    font-size: 24px;
    color: var(--text-color);
  }
  .embed-link .label {
    font-size: 0.8rem;
    text-align: center;
  }
  .embed-link .icon-circle.is-custom .label {
    font-size: 0.9rem;
  }

  
  #resources-view .embed-links {
    margin-top: auto; /* Push links to the bottom */
    padding-top: 10px;
  }

  .subjects-widget-container{
    height: 100%;
  }

  /* === SETTINGS PAGE === */
  #settings-grid {
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    align-content: start;
  }
  @media screen and (min-width: 1024px) {
    #settings-grid {
      grid-template-columns: 1fr 1fr 1fr; /* Three equal columns */
    }
    .settings-column {
      display: flex;
      flex-direction: column;
      gap: 20px;
      min-height: 0; /* Prevent flexbox overflow */
    }
    .settings-column > .widget-card {
      flex-grow: 1; /* Allow widgets to grow to fill the column */
      display: flex; /* Ensure widgets are flex containers */
    }
  }

  .settings-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    flex-wrap: wrap;
  }
  .settings-item:last-child { border-bottom: none; }
  .settings-item .name { flex-grow: 1; font-weight: 500; }
  .settings-item .action-btn {
    background-color: var(--accent-color);
    color: var(--bg-color);
    border: none;
    width: 36px; height: 36px;
    border-radius: 50%;
    cursor: pointer;
    display: grid; place-items: center;
    transition: background-color 0.2s ease;
  }
  .settings-item .action-btn.added {
    background-color: transparent;
    color: var(--accent-color);
    border: 1px solid var(--accent-color);
    cursor: default;
  }
  .widget-card .action-btn.remove { 
    background-color: #B00020; 
    color: white; 
    /* position: absolute;
    top: 15px;
    right: 15px; */
    /* height: 40px; */
    border-radius: 12px;
    align-self: flex-start; /* Align to top of flex container */
  }
  .settings-item .action-btn:hover { filter: brightness(1.2); }
  .settings-item .day-time-select {
    background-color: rgba(255,255,255,0.05);
    color: #ffffff;
    border-radius: 8px;
    padding: 8px 12px;
    font-family: var(--font-family);
    border: 1px solid transparent;
    transition: border-color 0.2s ease;
    font-weight: 600;
  }
  .widget-card .day-time-select {
    background-color: var(--accent-color);
    color: var(--text-on-accent-color);
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='white' class='bi bi-chevron-down' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 1em;
  }
  .day-time-select option { background-color: var(--widget-color); color: var(--text-color); }
  .settings-item .day-time-select:hover, .duration-selector select:hover {
    border-color: var(--accent-color);
  }
  .search-input-container {
    position: relative;
    margin-bottom: 15px;
  }
  .search-input-container .material-symbols-outlined {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted-color);
  }
  #catalog-search {
    width: 100%;
    padding: 15px 20px 15px 45px;
    background-color: transparent;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 999px;
    color: var(--text-color);
    font-size: 1rem;
    font-family: var(--font-family);
    outline: none;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }
  #catalog-search:focus {
    border-color: var(--accent-color);
  }
  .weekday-chooser {
    display: flex;
    gap: 5px;
    justify-content: flex-end;
    flex-wrap: wrap;
    flex-grow: 1;
  }
  .weekday-btn {
    width: 42px;
    height: 38px;
    border-radius: 12px;
    border: 1px solid transparent;
    background-color: rgba(255,255,255,0.05);
    color: var(--text-muted-color);
    cursor: pointer;
    display: grid;
    place-items: center;
    font-size: 0.8rem;
    font-weight: 600;
    transition: all 0.2s ease;
  }
  .weekday-btn:hover {
    background-color: rgba(255,255,255,0.1);
  }
  .weekday-btn.active {
    background-color: var(--accent-color);
    color: var(--bg-color);
  }
  .settings-widget-content { flex-grow: 1; min-height: 0; overflow-y: auto; padding-right: 5px; }
  .settings-widget-content::-webkit-scrollbar { width: 6px; }
  .settings-widget-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

  .list-nav-controls {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }
  .list-nav-btn {
    background: rgba(255,255,255,0.08);
    border: none; color: var(--text-color); border-radius: 8px;
    width: 36px; height: 36px; cursor: pointer; display: grid; place-items: center;
  }
  .list-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
  #settings-view .theme-selector .themes {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
  }
  .theme-option {
    border: 2px solid transparent;
    border-radius: 10px;
    padding: 15px;
    cursor: pointer;
    transition: border-color 0.2s ease;
    width: 150px;
  }
  .theme-option.active {
    border-color: var(--accent-color);
  }
  .theme-option .name {
    font-weight: 600;
    margin-bottom: 10px;
  }
  .theme-option .swatches {
    display: flex;
    gap: 5px;
  }
  .theme-option .swatch {
    width: 20px;
    height: 20px;
    border-radius: 50%;
  }
  #settings-view .save-button {
    background-color: var(--accent-color);
    color: var(--bg-color);
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    transition: background-color 0.2s ease;
  }
  #settings-view .logout-button {
    background-color: #B00020;
    color: white;
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    transition: background-color 0.2s ease;
  }
  #settings-view .logout-button:hover {
    background-color: #CF6679;
  }

  /* === BOTTOM NAVIGATION === */
  .bottom-nav {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    background-color: var(--widget-color);
    border-radius: 999px;
    padding: 10px;
    display: flex;
    gap: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    z-index: 1000;
  }
  .nav-item {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: grid;
    place-items: center;
    cursor: pointer;
    transition: background-color 0.2s ease;
    color: rgba(255, 255, 255, 0.6); /* Inactive icon color */
  }
  .nav-item .material-symbols-outlined {
    -webkit-user-select: none; /* Safari */
    -ms-user-select: none; /* IE 10+ and Edge */
    user-select: none; /* Standard syntax */
    font-size: 32px;
    transition: font-variation-settings 0.2s ease, color 0.2s ease;
    font-variation-settings: 'FILL' 0, 'wght' 200, 'GRAD' 0;
  }
  .nav-item.active {
    background-color: var(--accent-variant-color);
    color: #FFFFFF; /* Active icon color */
  }
  .nav-item.active .material-symbols-outlined {
    font-variation-settings: 'FILL' 1, 'wght' 200, 'GRAD' 0;
  }
  .nav-item.active {
    background-color: var(--accent-variant-color);
    color: var(--text-on-accent-color); /* Active icon color */
  }
  #week-selector {
    width: 100%;
    padding: 15px 20px;
    background-color: var(--widget-color);
    color: var(--text-color);
    border: none;
    border-radius: var(--border-radius);
    font-size: 1.1rem;
    font-family: var(--font-family);
    appearance: none;
    -webkit-appearance: none;
    cursor: pointer;
    font-weight: 600;
  }

  /* === WEEKS BAR (reimagined as dropdown) === */
  #weeks-bar-container {
    margin-bottom: 20px;
    position: relative;
  }

  .weeks-chooser {
    display: flex;
    gap: 12px;    
    width: 100%;
    overflow-x: auto;
    scrollbar-width: none;
    padding-bottom: 5px;
  }
  .weeks-chooser::-webkit-scrollbar { display: none; }

  .week-button {
    flex: 1;
    padding: 12px 5px;
    border-radius: 999px;
    background-color: var(--widget-color);
    color: var(--text-muted-color);
    border: 1px solid transparent;
    text-align: center;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
    font-size: 0.8rem;
    white-space: nowrap;
  }
  .week-button.is-current.active {
    color: var(--text-on-accent-color); /* Ensure text is white when it's the active current week */
  }

  .week-button:hover { background-color: color-mix(in srgb, var(--widget-color) 80%, white 20%); }
  .week-button.active { background-color: var(--accent-color); color: var(--text-on-accent-color); }
  .week-button.is-current { border: 1px solid var(--accent-color); color: var(--accent-color); }

  .empty-placeholder {
    text-align: center;
    color: var(--text-muted-color);
    padding: 40px;
    font-size: 1.1rem;
  }

  .weeks-mobile-nav {
    display: none; /* Hidden by default */
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    background-color: var(--widget-color);    
    border-radius: 999px; /* Full round edges */
    width: fit-content; /* Shrink to content */
    margin: 0 auto; /* Center horizontally */
    transition: background-color 0.2s ease;
  }

  .weeks-mobile-nav .nav-arrow {
    background: transparent;
    border: none;
    color: var(--text-color);
    cursor: pointer;
  }
   .weeks-mobile-nav .nav-arrow:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }
  .weeks-mobile-nav .current-week-display {
    font-weight: 600;
    font-size: 1rem;
    background-color: transparent; /* Neutral background by default */
    color: var(--text-color);
    padding: 5px 15px;
    border-radius: 999px;
    transition: background-color 0.2s ease, color 0.2s ease;
  }
  /* When the whole nav is the current week */
  .weeks-mobile-nav.is-current {
    background-color: var(--accent-color); /* Accent color for the current week */
  }
  .weeks-mobile-nav.is-current .current-week-display,
  .weeks-mobile-nav.is-current .nav-arrow {
    color: var(--text-on-accent-color);
    background-color: transparent; /* Ensure children are transparent */
  }

  @media screen and (max-width: 768px) {
    body {
      padding: 15px 15px 90px 15px;
    }
    .widget-grid {
      grid-template-columns: 1fr;
    }
    #home-grid, #resources-grid {
      grid-template-rows: none; /* Remove fixed rows for mobile */
      grid-template-columns: 1fr; /* Ensure single column layout */
    }

    #home-grid, #resources-grid, #settings-grid {
      height: auto; /* Allow grids to grow with content on mobile */
    }
    #live-time-card {
      display: none; /* Hide time widget on mobile */
    }
    .weeks-chooser {
      display: none; /* Hide desktop weeks bar on mobile */
    }
    .weeks-mobile-nav {
      display: flex; /* Show mobile weeks nav */
      width: 200px;
      padding: 6px 10px;
    }
    header h1 {
      font-size: 1.8rem;
    }
    .bottom-nav {
      bottom: 10px;
    }
    .nav-item {
      width: 50px;
      height: 50px;
    }
  }
</style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="login-overlay">
  <h1>Weekge</h1>
  <button id="signInBtn">
    <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google logo">
    Sign in with Google
  </button>
</div>

<!-- LOADER -->
<div id="loadingOverlay"><div class="spinner"></div><p>იტვირთება</p></div>

<!-- FULLSCREEN WEEK SELECTOR -->
<div id="week-selector-overlay">
  <div class="week-selector-grid"></div>
</div>

<header>
  <h1 id="page-title">მთავარი</h1>
</header>

<!-- MAIN CONTENT -->
<div class="main-content">
  
  <!-- HOME VIEW -->
  <div id="live-view" class="view active">
    <div id="weeks-bar-container">
      <!-- Weeks dropdown will be generated by JS -->
    </div>
    <div id="home-grid" class="widget-grid">
      <!-- Live Time and Subject cards will be rendered here by JS -->
    </div>
  </div>

  <!-- RESOURCES VIEW -->
  <div id="resources-view" class="view">
    <div id="resources-grid" class="widget-grid">
        <!-- Global resources will be rendered here by JS -->
    </div>
  </div>

  <!-- SETTINGS VIEW -->
  <div id="settings-view" class="view">
    <div id="settings-grid" class="widget-grid">
        <!-- Settings widgets will be rendered here by JS -->
    </div>
  </div>

</div>

<!-- BOTTOM NAVIGATION -->
<div class="bottom-nav">
  <div class="nav-item active" data-view="live-view" data-title="მთავარი">
    <span class="material-symbols-outlined">home</span>
  </div>
  <div class="nav-item" data-view="resources-view" data-title="რესურსები">
    <span class="material-symbols-outlined">widgets</span>
  </div>
  <div class="nav-item" data-view="settings-view" data-title="პარამეტრები">
    <span class="material-symbols-outlined">settings</span>
  </div>
</div>


<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* === UTILITIES === */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const el = (t, p = {}, kids = []) => {
  const e = document.createElement(t);
  Object.assign(e, p);
  kids.forEach(k => e.append(k));
  return e;
};

function setCookie(name, value, days) {
  let expires = "";
  if (days) {
    const date = new Date();
    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
    expires = "; expires=" + date.toUTCString();
  }
  document.cookie = name + "=" + (value || "") + expires + "; path=/";
}

function getCookie(name) {
  const nameEQ = name + "=";
  const ca = document.cookie.split(';');
  for (let i = 0; i < ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) === ' ') c = c.substring(1, c.length);
    if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
  }
  return null;
}

/* === MAIN APP SCRIPT === */
const overlay = $("#loadingOverlay");

fetch("https://raw.githubusercontent.com/WEEKGE/live/main/config.json")
  .then(r => r.json())
  .then(cfg => {
    firebase.initializeApp(cfg);
    startWeekge();
  })
  .catch(() => {
    overlay.innerHTML = "<h2 style='color:red;text-align:center;margin-top:30vh;'>⚠️ config.json ვერ ჩაიტვირთა.</h2>";
  });

function startWeekge() {
  const auth = firebase.auth(), db = firebase.firestore();
  let user = null, catalog = [], selected = [], cache = {}, weekDates = [], userDays = {}, userThemeName = null, lectureDuration = "03:00", mySubjectsPageIndex = 0;
  let currentWeekData = null, selectedWeekNumber = null;

  const daysOfWeek = ["ორშაბათი","სამშაბათი","ოთხშაბათი","ხუთშაბათი","პარასკევი","შაბათი","კვირა"];

  const todayISO = () => new Date().toISOString().slice(0, 10);
  const isBetween = (d, s, e) => d >= s && d <= e;

  const SEMESTER_WEEKS = [
    {n:1,start1:"2025-09-22",end1:"2025-09-28",start2:"2026-03-02",end2:"2026-03-08"},
    {n:2,start1:"2025-09-29",end1:"2025-10-05",start2:"2026-03-09",end2:"2026-03-15"},
    {n:3,start1:"2025-10-06",end1:"2025-10-12",start2:"2026-03-16",end2:"2026-03-22"},
    {n:4,start1:"2025-10-13",end1:"2025-10-19",start2:"2026-03-23",end2:"2026-03-29"},
    {n:5,start1:"2025-10-20",end1:"2025-10-26",start2:"2026-03-30",end2:"2026-04-05"},
    {n:6,start1:"2025-10-27",end1:"2025-11-02",start2:"2026-04-06",end2:"2026-04-12"},
    {n:7,start1:"2025-11-03",end1:"2025-11-09",start2:"2026-04-20",end2:"2026-04-26"},
    {n:8,start1:"2025-11-10",end1:"2025-11-16",start2:"2026-04-27",end2:"2026-05-03"},
    {n:9,start1:"2025-11-17",end1:"2025-11-23",start2:"2026-05-04",end2:"2026-05-10"},
    {n:10,start1:"2025-11-24",end1:"2025-11-30",start2:"2026-05-11",end2:"2026-05-17"},
    {n:11,start1:"2025-12-01",end1:"2025-12-07",start2:"2026-05-18",end2:"2026-05-24"},
    {n:12,start1:"2025-12-08",end1:"2025-12-14",start2:"2026-05-25",end2:"2026-05-31"},
    {n:13,start1:"2025-12-15",end1:"2025-12-20",start2:"2026-06-01",end2:"2026-06-06"}
  ];

  const THEMES = {
    "Default": { bg: "#121212", widget: "#1E1E1E", text: "#fff", accent: "#fff", accentVariant: "#fff", textOnAccent: "#000000" },
    "Ocean": { bg: "#0F2027", widget: "#203A43", text: "#ffffff", accent: "#1488CC", accentVariant: "#2B32B2", textOnAccent: "#FFFFFF" },
    "Sunset": { bg: "#2C0A1E", widget: "#4F1C3A", text: "#ffffff", accent: "#FF8C61", accentVariant: "#C83C66", textOnAccent: "#000000" },
    "Forest": { bg: "#1A2922", widget: "#2E463A", text: "#ffffff", accent: "#56C271", accentVariant: "#237A41", textOnAccent: "#000000" },
  };

  function applyTheme(themeName) {
    const theme = THEMES[themeName] || THEMES["Default"];
    const root = document.documentElement;
    root.style.setProperty('--bg-color', theme.bg);
    root.style.setProperty('--widget-color', theme.widget);
    root.style.setProperty('--text-color', theme.text);
    root.style.setProperty('--accent-color', theme.accent);
    root.style.setProperty('--accent-variant-color', theme.accentVariant);
    root.style.setProperty('--text-on-accent-color', theme.textOnAccent);
    userThemeName = themeName;
  }

  async function saveTheme(themeName) { // This function is for theme only
    applyTheme(themeName);
    if (user) {
      await db.collection("users").doc(user.uid).set({ userThemeName: themeName }, { merge: true });
    }
    setCookie('userThemeName', themeName, 365);
  }

  let saveTimeout;
  function autoSave() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(saveSettings, 1200); // Debounce saves by 1.2 seconds
  }

  async function saveSettings() { // This now handles subjects and duration
    if (user) {
      await db.collection("users").doc(user.uid).set({ 
        subjects: selected, 
        days: userDays,
        lectureDuration: lectureDuration
      }, { merge: true });
    }
    setCookie('selectedSubjects', JSON.stringify(selected), 365);
    setCookie('userDays', JSON.stringify(userDays), 365);
    setCookie('lectureDuration', lectureDuration, 365);

    // Re-render pages to reflect changes without a full reload
    renderHomePage();
    renderResourcesPage();
    console.log("Settings auto-saved.");
  }

  /* === AUTHENTICATION === */
  auth.onAuthStateChanged(async u => {
    user = u || null;
    try {
      const loginOverlay = $("#login-overlay");
      if (user) {
        loginOverlay.style.display = "none";
        await bootAfterLogin();
      } else {
        loginOverlay.style.display = "flex";
      }
    } catch (error) {
      console.error("Bootstrapping failed:", error);
      overlay.innerHTML = `<h2 style='color:red;text-align:center;margin-top:30vh;'>⚠️ აპლიკაციის ჩატვირთვა ვერ მოხერხდა.</h2><p style='color:var(--text-muted-color)'>${error.message}</p>`;
    } finally {
      // Always hide the main loader, regardless of success or failure
      overlay.classList.add("hidden");
    }
  });

  $("#signInBtn").onclick = async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      await auth.signInWithPopup(provider);
    } catch (err) {
      console.error("Sign-in error:", err);
      let userMessage = "Sign-in failed. Please try again.";
      if (err.code === 'auth/popup-closed-by-user') {
        // Don't show a harsh error if the user simply closed the window.
        return; 
      } else if (err.code === 'auth/popup-blocked') {
        userMessage = "Sign-in popup was blocked by the browser. Please allow popups for this site and try again.";
      } else {
        userMessage = `Sign-in failed: ${err.message}`;
      }
      alert(userMessage);
    }
  };

  /* === APP BOOTSTRAP === */
  async function bootAfterLogin() {
    await loadData();
    flattenWeeks();
    initCurrentWeek();
    
    renderWeeksBar();
    renderHomePage();
    renderResourcesPage();
    renderSettingsPage();
    
    initLiveTime();
    initNavigation();
  }

  async function loadData() {
    // Load catalog
    const catalogSnap = await db.collection("subjects").get();
    catalog = catalogSnap.docs.map(d => ({ id: d.id, ...d.data() }));

    // Load user data
    let data = {};
    if (user) {
      const userSnap = await db.collection("users").doc(user.uid).get();
      data = userSnap.exists ? userSnap.data() : {};
    } else {
      // Fallback to cookies if not logged in
      data.subjects = JSON.parse(getCookie('selectedSubjects') || '[]');
      data.days = JSON.parse(getCookie('userDays') || '{}');
      data.userThemeName = getCookie('userThemeName') || "Default";
      data.lectureDuration = getCookie('lectureDuration') || "03:00";
    }

    selected = data.subjects || [];
    userDays = data.days || {};
    userThemeName = data.userThemeName || "Default";
    applyTheme(userThemeName);

    lectureDuration = data.lectureDuration || "03:00";
    // Ensure subjects are in cache
    const toLoad = selected.filter(id => !cache[id]);
    for (const id of toLoad) {
      const subj = catalog.find(c => c.id === id);
      if (subj) cache[id] = subj;
    }
  }

  function flattenWeeks() {
    weekDates = [];
    SEMESTER_WEEKS.forEach(w => {
      if (w.start1) weekDates.push({ n: w.n, start: w.start1, end: w.end1 });
      if (w.start2) weekDates.push({ n: w.n, start: w.start2, end: w.end2 });
    });
  }

  function initCurrentWeek() {
    const iso = todayISO();
    currentWeekData = weekDates.find(w => isBetween(iso, w.start, w.end)) || weekDates[0];
    selectedWeekNumber = currentWeekData ? currentWeekData.n : (weekDates.length > 0 ? weekDates[0].n : 1);
  }

  /* === NAVIGATION === */
  function initNavigation() {
    const navItems = $$('.nav-item');
    const views = $$('.view');
    const pageTitle = $('#page-title');

    navItems.forEach(item => {
      item.addEventListener('click', () => {
        const viewId = item.dataset.view;
        
        navItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');

        views.forEach(v => v.classList.remove('active'));
        $(`#${viewId}`).classList.add('active');

        pageTitle.textContent = item.dataset.title;
      });
    });
  }

  /* === LIVE TIME WIDGET === */
  function initLiveTime() {
    const timeEl = el('div', { className: 'time' });
    const dateEl = el('div', { className: 'date' });
    const timeCard = el('div', { id: 'live-time-card', className: 'widget-card' }, [timeEl, dateEl]);

    $('#home-grid').prepend(timeCard);

    function updateTime() {
      const now = new Date();
      timeEl.textContent = now.toLocaleTimeString('ka-GE', { hour: '2-digit', minute: '2-digit' });
      dateEl.textContent = now.toLocaleDateString('ka-GE', { weekday: 'long', month: 'long', day: 'numeric' });
    }
    updateTime();
    setInterval(updateTime, 1000);
  }

  /* === WEEKS BAR / SELECTOR === */
  function renderWeeksBar() {
    const container = $('#weeks-bar-container');
    container.innerHTML = '';

    // --- Fullscreen Overlay Logic ---
    const weekSelectorOverlay = $('#week-selector-overlay');
    const weekSelectorGrid = $('.week-selector-grid');
    weekSelectorOverlay.onclick = (e) => { if (e.target === weekSelectorOverlay) weekSelectorOverlay.classList.remove('visible'); };

    // --- Mobile Navigator ---
    const prevWeek = () => {
        const currentIndex = SEMESTER_WEEKS.findIndex(w => w.n === selectedWeekNumber);
        if (currentIndex > 0) {
            selectedWeekNumber = SEMESTER_WEEKS[currentIndex - 1].n;
            renderHomePage();
            renderWeeksBar();
        }
    };
    const nextWeek = () => {
        const currentIndex = SEMESTER_WEEKS.findIndex(w => w.n === selectedWeekNumber);
        if (currentIndex < SEMESTER_WEEKS.length - 1) {
            selectedWeekNumber = SEMESTER_WEEKS[currentIndex + 1].n;
            renderHomePage();
            renderWeeksBar();
        }
    };
    const mobileNav = el('div', { className: 'weeks-mobile-nav' });
    const weekDisplay = el('div', { className: 'current-week-display', textContent: `კვირა ${selectedWeekNumber}` });

    if (currentWeekData && selectedWeekNumber === currentWeekData.n) {
      mobileNav.classList.add('is-current');
    }

    mobileNav.append(el('button', { className: 'nav-arrow', onclick: prevWeek, disabled: selectedWeekNumber === 1 }, [el('span', {className: 'material-symbols-outlined', textContent: 'arrow_back_ios'})]));
    mobileNav.append(weekDisplay);
    mobileNav.append(el('button', { className: 'nav-arrow', onclick: nextWeek, disabled: selectedWeekNumber === SEMESTER_WEEKS.length }, [el('span', {className: 'material-symbols-outlined', textContent: 'arrow_forward_ios'})]));
    container.append(mobileNav);
  }

  /* === RENDERING FUNCTIONS === */

  function getEmbedIcon(type) {
    switch (type?.toLowerCase()) {
      case 'slide': return 'slideshow';
      case 'video': return 'play_circle';
      case 'book': return 'menu_book';
      default: return 'link';
    }
  }

  function createEmbedLinks(buttons) {
    const container = el('div', { className: 'embed-links' });
    if (!buttons || buttons.length === 0) return container;

    buttons.forEach(b => {
      const isCustom = b.type === 'custom';
      const iconCircleClass = isCustom ? 'icon-circle is-custom' : 'icon-circle';
      const linkClass = isCustom ? 'embed-link is-custom' : 'embed-link';

      const link = el('a', { className: linkClass, href: b.link || '#', target: '_blank', title: b.label }, [
        el('div', { className: iconCircleClass }, [
          el('span', { className: 'material-symbols-outlined', textContent: getEmbedIcon(b.type) }),
          ...(isCustom ? [el('span', { className: 'label', textContent: b.label })] : []) ]) ]);
      container.append(link);
    });
    return container;
  }

  function renderHomePage() {
    const grid = $('#home-grid');
    // Clear only subject cards, not the time widget
    $$('#home-grid .subject-card').forEach(card => card.remove());

    const todayDayIndex = new Date().getDay() === 0 ? 6 : new Date().getDay() - 1;

    const subjectsForWeek = selected.map(id => {
        const subj = cache[id];
        if (!subj) return null;

        // Find the specific data for the currently selected week
        const weekData = subj.weeks?.find(w => w.week === selectedWeekNumber - 1) || {};

        const dayData = userDays?.[id] ?? { day: null, time: null };

        return {
            ...subj,
            // Pass along the specific week's data
            weekTopic: weekData.topic || '<i>თემა არ არის მითითებული</i>',
            weekType: weekData.type,
            weekButtons: weekData.buttons,
            dayIndex: daysOfWeek.indexOf(dayData.day),
            time: dayData.time,
            isScheduled: dayData.day !== null
        };
    }).filter(Boolean);

    // Sort subjects: scheduled first, then by upcoming, day, time, and name.
    subjectsForWeek.sort((a, b) => {
        const aScheduled = a.dayIndex > -1;
        const bScheduled = b.dayIndex > -1;

        if (aScheduled && !bScheduled) return -1;
        if (!aScheduled && bScheduled) return 1;
        if (!aScheduled && !bScheduled) return a.name.localeCompare(b.name);

        // Both are scheduled
        const isAUpcoming = a.dayIndex >= todayDayIndex;
        const isBUpcoming = b.dayIndex >= todayDayIndex;

        if (isAUpcoming !== isBUpcoming) return isAUpcoming ? -1 : 1;

        if (a.dayIndex !== b.dayIndex) return a.dayIndex - b.dayIndex;

        if (a.time && b.time) return a.time.localeCompare(b.time);
        
        return a.name.localeCompare(b.name); // final fallback
    });

    if (subjectsForWeek.length === 0) {
        if (!$('.empty-placeholder')) {
            grid.append(el('p', {className: 'empty-placeholder', textContent: 'საგნები არ არის არჩეული. დაამატე პარამეტრებიდან.'}));
        }
        return;
    } else {
        const placeholder = $('.empty-placeholder');
        if (placeholder) placeholder.remove();
    }

    subjectsForWeek.forEach(subj => {
      const isUpcoming = subj.isScheduled && subj.dayIndex >= todayDayIndex;
      const cardClasses = ['widget-card', 'subject-card'];
      if (isUpcoming) {
        cardClasses.push('is-upcoming');
      }

      const card = el('div', { className: cardClasses.join(' ') }, [
        el('h3', { className: 'widget-title', textContent: subj.name }),
        el('p', { className: 'widget-subtitle', textContent: subj.weekType || 'ლექცია' }),
        el('div', { className: 'topic', innerHTML: subj.weekTopic }),
        createEmbedLinks(subj.weekButtons)
      ]);


      grid.append(card);
    });
  }

  function renderResourcesPage() {
    const grid = $('#resources-grid');
    grid.innerHTML = '';

    const todayDayIndex = new Date().getDay() === 0 ? 6 : new Date().getDay() - 1;

    const subjectsWithGlobalButtons = selected.map(id => {
        const subj = cache[id];
        if (!subj || !subj.globalButtons || subj.globalButtons.length === 0) return null;

        const dayData = userDays?.[id] ?? { day: null, time: null };

        return {
            ...subj,
            dayIndex: daysOfWeek.indexOf(dayData.day),
            time: dayData.time,
            isScheduled: dayData.day !== null
        };
    }).filter(Boolean);

    // Sort subjects: scheduled first, then by upcoming, day, time, and name.
    subjectsWithGlobalButtons.sort((a, b) => {
        const aScheduled = a.dayIndex > -1;
        const bScheduled = b.dayIndex > -1;

        if (aScheduled && !bScheduled) return -1;
        if (!aScheduled && bScheduled) return 1;
        if (!aScheduled && !bScheduled) return a.name.localeCompare(b.name);

        // Both are scheduled
        const isAUpcoming = a.dayIndex >= todayDayIndex;
        const isBUpcoming = b.dayIndex >= todayDayIndex;

        if (isAUpcoming !== isBUpcoming) return isAUpcoming ? -1 : 1;

        if (a.dayIndex !== b.dayIndex) return a.dayIndex - b.dayIndex;

        if (a.time && b.time) return a.time.localeCompare(b.time);
        
        return a.name.localeCompare(b.name); // final fallback
    });

    if (subjectsWithGlobalButtons.length === 0) {
        grid.append(el('p', {className: 'empty-placeholder', textContent: 'არჩეულ საგნებს არ აქვს გლობალური რესურსები.'}));
        return;
    }

    subjectsWithGlobalButtons.forEach(subj => {
      const card = el('div', { className: 'widget-card' }, [
        el('h3', { className: 'widget-title', textContent: subj.name }),
        createEmbedLinks(subj.globalButtons)
      ]);
      grid.append(card);
    });
  }

  function renderSettingsPage() {
    const grid = $('#settings-grid');
    grid.innerHTML = '';

    // Create containers for the layout
    const mySubjectsColumn = el('div', { className: 'settings-column' });
    const catalogColumn = el('div', { className: 'settings-column' });
    const sideColumn = el('div', { className: 'settings-column' });

    // -- My Subjects Widget (with pagination) --
    const mySubjectsContent = el('div', { className: 'settings-widget-content' });
    const pageSize = 3;
    const sortedSelected = selected.map(id => cache[id]).filter(Boolean).sort((a, b) => a.name.localeCompare(b.name));
    const maxPage = Math.ceil(sortedSelected.length / pageSize) - 1;
    
    // Clamp the start index to valid bounds
    if (mySubjectsPageIndex > maxPage) {
      mySubjectsPageIndex = Math.max(0, maxPage);
    }

    const startIndex = mySubjectsPageIndex * pageSize;
    const visibleSubjects = sortedSelected.slice(startIndex, startIndex + pageSize);
    visibleSubjects.forEach(subj => {
        const subjectWidget = createMySubjectWidget(subj);
        mySubjectsContent.append(subjectWidget);
    });

    let mySubjectsCard;
    if (sortedSelected.length > pageSize) {
        const upBtn = el('button', { className: 'list-nav-btn', disabled: mySubjectsPageIndex === 0 }, [el('span', {className: 'material-symbols-outlined', textContent: 'expand_less'})]);
        const downBtn = el('button', { className: 'list-nav-btn', disabled: mySubjectsPageIndex >= maxPage }, [el('span', {className: 'material-symbols-outlined', textContent: 'expand_more'})]);
        
        upBtn.onclick = () => { mySubjectsPageIndex = Math.max(0, mySubjectsPageIndex - 1); renderSettingsPage(); };
        downBtn.onclick = () => { mySubjectsPageIndex = Math.min(mySubjectsPageIndex + 1, maxPage); renderSettingsPage(); };

        const navControls = el('div', { className: 'list-nav-controls' }, [upBtn, downBtn]);
        const contentWrapper = el('div', { style: 'display: flex; gap: 15px; flex-grow: 1;'}, [mySubjectsContent, navControls]);
        
        mySubjectsCard = el('div', { id: 'my-subjects-widget', className: 'widget-card', style: 'flex: 1;' }, [
            el('h3', { className: 'widget-title', textContent: 'ჩემი საგნები' }),
            contentWrapper
        ]);
    } else {
        mySubjectsCard = el('div', { id: 'my-subjects-widget', className: 'widget-card', style: 'flex: 1;' }, [
            el('h3', { className: 'widget-title', textContent: 'ჩემი საგნები' }),
            mySubjectsContent
        ]);
    }
    mySubjectsColumn.append(mySubjectsCard);
    // -- Subjects Catalog Widget --
    const searchInput = el('input', { id: 'catalog-search', type: 'search', placeholder: 'საგნის მოძებნა...' });
    const searchContainer = el('div', { className: 'search-input-container' }, [
        el('span', { className: 'material-symbols-outlined', textContent: 'search' }),
        searchInput
    ]);

    const catalogContent = el('div', { className: 'settings-widget-content', style: 'padding-right: 0;' });
    
    const renderCatalogItems = (filter = '') => {
        catalogContent.innerHTML = '';
        let subjectsToShow;

        if (filter) {
            // If searching, filter the whole sorted catalog
            const sortedCatalog = [...catalog].sort((a, b) => a.name.localeCompare(b.name));
            subjectsToShow = sortedCatalog.filter(subj => subj.name.toLowerCase().includes(filter.toLowerCase()));
        } else {
            // If not searching, show up to 5 random subjects
            const shuffled = [...catalog].sort(() => 0.5 - Math.random());
            subjectsToShow = shuffled.slice(0, 5);
        }

        subjectsToShow.forEach(subj => {
            const isAdded = selected.includes(subj.id);
            let button;

            if (isAdded) {
                button = el('button', { className: 'action-btn added', disabled: true }, [ el('span', { className: 'material-symbols-outlined', textContent: 'check' }) ]);
            } else {
                button = el('button', { className: 'action-btn' }, [ el('span', { className: 'material-symbols-outlined', textContent: 'add' }) ]);
                button.onclick = () => { selected.push(subj.id); autoSave(); renderSettingsPage(); };
            }
            catalogContent.append(el('div', { className: 'settings-item' }, [ el('div', { className: 'name', textContent: subj.name }), button ]));
        });
    };

    searchInput.oninput = () => renderCatalogItems(searchInput.value);
    renderCatalogItems(); // Initial render

    const catalogCard = el('div', { id: 'catalog-widget', className: 'widget-card', style: 'flex: 1; min-height: 0;' }, [
      el('h3', { className: 'widget-title', textContent: 'საგნების კატალოგი' }),
      searchContainer,
      catalogContent
    ]);

    catalogColumn.append(catalogCard);

    // -- Lecture Duration Widget --
    const durationCard = createDurationWidget();
    sideColumn.append(durationCard);

    // -- Theme Selector Widget --
    const themeCard = createThemeWidget();
    sideColumn.append(themeCard);

    // -- Logout Widget --
    const logoutCard = createLogoutWidget();
    sideColumn.append(logoutCard);

    grid.append(mySubjectsColumn, catalogColumn, sideColumn);
  }

  function createMySubjectWidget(subj) {
      const lectureStartTimes = ["09:00", "11:20", "13:40", "16:00", "18:20"];
      const dayAbbreviations = ["ორშ", "სამ", "ოთხ", "ხუთ", "პარ", "შაბ", "კვ"];
      const currentDay = userDays[subj.id]?.day;

      const timeSelect = el('select', { className: 'day-time-select' });
      lectureStartTimes.forEach(time => {
        const opt = el('option', { value: time, textContent: time });
        if (userDays[subj.id]?.time === time) opt.selected = true;
        timeSelect.append(opt);
      });
      timeSelect.onchange = () => {
        if (!userDays[subj.id]) userDays[subj.id] = { day: null, time: null };
        userDays[subj.id].time = timeSelect.value;
        autoSave();
      };

      const weekdayContainer = el('div', { className: 'weekday-chooser' });
      daysOfWeek.forEach((day, index) => {
        const dayBtn = el('button', {
          className: 'weekday-btn',
          textContent: dayAbbreviations[index],
          title: day
        });
        if (currentDay === day) {
          dayBtn.classList.add('active');
        }
        dayBtn.onclick = () => {
          if (!userDays[subj.id]) userDays[subj.id] = { day: null, time: null };
          
          if (userDays[subj.id].day === day) {
            userDays[subj.id].day = null; // Deselect
          } else {
            userDays[subj.id].day = day; // Select
          }
          
          autoSave();
          renderSettingsPage(); // Re-render to show active state change
        };
        weekdayContainer.append(dayBtn);
      });

      const removeBtn = el('button', { className: 'action-btn remove' }, [
        el('span', { className: 'material-symbols-outlined', textContent: 'remove' })
      ]);
      removeBtn.onclick = () => {
        selected = selected.filter(id => id !== subj.id);
        delete userDays[subj.id];
        // mySubjectsPageIndex will be auto-clamped on re-render
        autoSave();
        renderSettingsPage();
      };

      const controls = el('div', { style: 'display: flex; flex-direction: column; gap: 10px; flex-grow: 1;'}, [
        el('h3', { className: 'widget-title', textContent: subj.name, style: 'font-size: 1.1rem; margin-bottom: 5px;' }),
        weekdayContainer,
        timeSelect
      ]);

      // This is now an item within a widget, not a full widget-card itself.
      return el('div', { className: 'settings-item', style: 'align-items: flex-start; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 12px; gap: 15px;' }, [
          removeBtn,
          controls,
      ]);
  }

  function createDurationWidget() {
    const [initialHour, initialMinute] = lectureDuration.split(':');

    const hourSelect = el('select', { className: 'day-time-select' });
    for (let i = 0; i <= 4; i++) {
      hourSelect.append(el('option', { value: i, textContent: `${i} სთ`, selected: i == initialHour }));
    }

    const minuteSelect = el('select', { className: 'day-time-select' });
    for (let i = 0; i <= 55; i += 5) {
      minuteSelect.append(el('option', { value: i, textContent: `${i} წთ`, selected: i == initialMinute }));
    }

    const updateDuration = () => {
      lectureDuration = `${hourSelect.value}:${minuteSelect.value}`;
      autoSave();
    };
    hourSelect.onchange = updateDuration;
    minuteSelect.onchange = updateDuration;

    const container = el('div', { className: 'duration-selector', style: 'display: flex; gap: 10px; margin-top: 10px;' }, [hourSelect, minuteSelect]);
    return el('div', { className: 'widget-card' }, [
      el('h3', { className: 'widget-title', textContent: 'ლექციის ხანგრძლივობა' }),
      container
    ]);
  }

  function createThemeWidget() {
    // Theme Selector Widget
    const themeOptions = Object.keys(THEMES).map(themeName => {
        const theme = THEMES[themeName];
        const option = el('div', { className: 'theme-option', style: 'cursor: pointer;' }, [
            el('div', { className: 'name', textContent: themeName }),
            el('div', { className: 'swatches' }, [
                el('div', { className: 'swatch', style: `background-color: ${theme.bg}` }),
                el('div', { className: 'swatch', style: `background-color: ${theme.widget}` }),
                el('div', { className: 'swatch', style: `background-color: ${theme.accent}` }),
            ])
        ]);
        if (themeName === userThemeName) {
            option.classList.add('active');
        }
        option.onclick = () => {
            saveTheme(themeName);
            // Re-render to show active state
            renderSettingsPage();
        };
        return option;
    });

    return el('div', { className: 'widget-card theme-selector' }, [
      el('h3', { className: 'widget-title', textContent: 'თემის არჩევა' }),
      el('div', { className: 'themes' }, themeOptions)
    ]);
  }

  function createLogoutWidget() {

    // Logout Widget
    const logoutButton = el('button', {
        className: 'logout-button',
        textContent: 'გასვლა'
    });
    logoutButton.onclick = async () => {
        try {
            await auth.signOut();
            location.reload();
        } catch (error) {
            console.error("Error signing out:", error);
        }
    };
    return el('div', { className: 'widget-card' }, [logoutButton]);
  }

  function markDirty() {
    // This function is no longer needed with auto-save.
  }
}
</script>
</body>
</html>