<!DOCTYPE html>
<html lang="ka">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Weekge</title>

  <meta name="description" content="Weekge (Week.ge) — უნივერსიტეტის საგნების და სილაბუსების პლატფორმა. ნახე შენი საგნები კვირების მიხედვით და იოლი ნავიგაციით.">
  <meta name="theme-color" content="#0B1216">
  <link rel="icon" href="/icons/shicon.png">

<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wdth,wght@62.5..100,100..900&display=swap" rel="stylesheet">

<style>
  :root {
    --bg-color: #121212;
    --widget-color: #1E1E1E;
    --text-color: #E0E0E0;
    --text-muted-color: #8A8A8A;
    --accent-color: #BB86FC;
    --accent-variant-color: #3700B3;
    --border-radius: 16px;
    --font-family: "Noto Sans Georgian", sans-serif;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html {
    color-scheme: dark;
  }

  body {
    background-color: var(--bg-color);
    color: var(--text-color);
    font-family: var(--font-family);
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
    padding: 20px 20px 100px 20px; /* Padding for content, space for bottom nav */
  }

  /* === LOADER === */
  #loadingOverlay {
    position: fixed; inset: 0; z-index: 9999;
    background: var(--bg-color); display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    transition: opacity .3s ease, visibility .3s ease;
  }
  #loadingOverlay.hidden { opacity: 0; visibility: hidden; }
  #loadingOverlay .spinner {
    width: 80px; height: 80px; border: 8px solid rgba(255,255,255,0.1);
    border-top: 8px solid var(--accent-color); border-radius: 50%;
    animation: spin 0.5s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  #loadingOverlay p { margin-top: 20px; font-size: 1.1rem; color: var(--text-muted-color); }

  /* === LOGIN OVERLAY === */
  #login-overlay {
    display: none; position: fixed; inset: 0; background: var(--bg-color); z-index: 10000; 
    flex-direction: column; align-items: center; justify-content: center; gap: 20px;
  }
  #login-overlay h1 { font-size: 3rem; color: var(--accent-color); }
  #signInBtn {
    background: #fff; color: #000; border: none; padding: 12px 24px; font-size: 1.1rem; 
    cursor: pointer; display: flex; align-items: center; gap: 12px; border-radius: 8px;
  }
  #signInBtn img { height: 24px; }

  /* === HEADER === */
  header {
    padding: 0 10px 20px 10px;
  }
  header h1 {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-color);
  }

  /* === MAIN CONTENT & VIEWS === */
  .main-content {
    flex: 1;
    overflow-y: auto;
    padding-right: 5px; /* space for scrollbar */
  }
  .main-content::-webkit-scrollbar { width: 8px; }
  .main-content::-webkit-scrollbar-thumb { background: var(--widget-color); border-radius: 4px; }
  .main-content::-webkit-scrollbar-track { background: transparent; }

  .view {
    display: none;
    animation: fadeIn 0.3s ease-in-out;
  }
  .view.active {
    display: block;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* === WIDGET GRID SYSTEM === */
  .widget-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
  }

  /* === WIDGET CARD STYLING === */
  .widget-card {
    background-color: var(--widget-color);
    border-radius: var(--border-radius);
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    transition: box-shadow 0.2s ease;
  }
  .widget-card:hover {
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
  }

  .widget-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-color);
  }
  .widget-subtitle {
    font-size: 0.9rem;
    color: var(--text-muted-color);
    margin-top: -10px;
  }

  /* === HOME PAGE WIDGETS === */
  #live-time-card {
    text-align: center;
    justify-content: center;
  }
  #live-time-card .time {
    font-size: 3.5rem;
    font-weight: 700;
  }
  #live-time-card .date {
    font-size: 1.2rem;
    color: var(--text-muted-color);
  }

  .subject-card .topic {
    font-size: 1rem;
    line-height: 1.5;
    color: var(--text-muted-color);
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  .subject-card .embed-links {
    display: flex;
    gap: 15px;
    margin-top: auto; /* Pushes to bottom */
    padding-top: 10px;
  }
  .embed-link {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    color: var(--text-muted-color);
    transition: color 0.2s ease;
  }
  .embed-link.is-custom {
    flex-direction: row; /* For custom links, align horizontally */
  }
  .embed-link:hover {
    color: var(--accent-color);
  }
  .embed-link .icon-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: rgba(255,255,255,0.05);
    display: grid;
    place-items: center;
    transition: background-color 0.2s ease;
  }
  .embed-link .icon-circle.is-custom {
    width: auto; /* Auto-width for custom links */
    border-radius: 25px; /* Pill shape */
    padding: 0 15px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .embed-link:hover .icon-circle {
    background-color: var(--accent-variant-color);
  }
  .embed-link .icon-circle .material-symbols-outlined {
    font-size: 24px;
    color: var(--text-color);
  }
  .embed-link .label {
    font-size: 0.8rem;
    text-align: center;
  }
  .embed-link .icon-circle.is-custom .label {
    font-size: 0.9rem;
  }

  /* === RESOURCES PAGE === */
  #resources-view .widget-card {
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
  }
  #resources-view .widget-title {
    flex-grow: 1;
  }

  .subjects-widget-container{
    height: 100%;
  }

  /* === SETTINGS PAGE === */
  #settings-grid {
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    height: 100%;
    align-content: start;
  }
  @media screen and (min-width: 1024px) {
    #settings-grid {
      grid-template-columns: 2fr 1fr; /* 2/3 for subjects, 1/3 for others */
    }
    .subjects-widget-container {
      grid-column: 1 / 2;
      display: flex;
      flex-direction: row;
      gap: 20px;
    }
    .side-widget-container {
      grid-column: 2 / 3;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .subjects-widget-container > .widget-card {
      flex: 1 1 0; /* Allow widgets to grow and shrink */
    }
    .widget-card { min-height: 0; } /* Prevent flex items from overflowing their container */
    #my-subjects-widget {
      /* Ensure the widget itself is a flex container to manage its children's height */
      display: flex;
    }
  }

  .settings-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    flex-wrap: wrap;
  }
  .settings-item:last-child { border-bottom: none; padding-bottom: 0; }
  .settings-item .name { flex-grow: 1; font-weight: 500; }
  .settings-item .action-btn {
    background-color: var(--accent-color);
    color: var(--bg-color);
    border: none;
    width: 36px; height: 36px;
    border-radius: 50%;
    cursor: pointer;
    display: grid; place-items: center;
    transition: background-color 0.2s ease;
  }
  .settings-item .action-btn.remove { 
    background-color: #B00020; 
    color: white; 
    position: absolute;
    top: 10px;
    right: 0;
  }
  .settings-item .action-btn:hover { filter: brightness(1.2); }
  .settings-item .day-time-select {
    background-color: rgba(255,255,255,0.05);
    color: var(--text-color);
    border: 1px solid transparent;
    border-radius: 8px;
    padding: 8px 12px;
    font-family: var(--font-family);
  }
  .weekday-chooser {
    display: flex;
    gap: 5px;
    justify-content: flex-end;
    flex-wrap: wrap;
    flex-grow: 1;
  }
  .weekday-btn {
    width: 42px;
    height: 38px;
    border-radius: 50%;
    border: 1px solid transparent;
    background-color: rgba(255,255,255,0.05);
    color: var(--text-muted-color);
    cursor: pointer;
    display: grid;
    place-items: center;
    font-size: 0.8rem;
    font-weight: 600;
    transition: all 0.2s ease;
  }
  .weekday-btn:hover {
    background-color: rgba(255,255,255,0.1);
  }
  .weekday-btn.active {
    background-color: var(--accent-color);
    color: var(--bg-color);
  }
  .settings-widget-content { flex-grow: 1; min-height: 0; overflow-y: auto; padding-right: 10px; }
  .settings-widget-content::-webkit-scrollbar { width: 6px; }
  .settings-widget-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

  #settings-view .theme-selector .themes {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
  }
  .theme-option {
    border: 2px solid transparent;
    border-radius: 10px;
    padding: 15px;
    cursor: pointer;
    transition: border-color 0.2s ease;
    width: 150px;
  }
  .theme-option.active {
    border-color: var(--accent-color);
  }
  .theme-option .name {
    font-weight: 600;
    margin-bottom: 10px;
  }
  .theme-option .swatches {
    display: flex;
    gap: 5px;
  }
  .theme-option .swatch {
    width: 20px;
    height: 20px;
    border-radius: 50%;
  }

  #settings-view{
    height: 100%;
  }
  #settings-view .save-button {
    background-color: var(--accent-color);
    color: var(--bg-color);
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    transition: background-color 0.2s ease;
  }
  #settings-view .logout-button {
    background-color: #B00020;
    color: white;
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    transition: background-color 0.2s ease;
  }
  #settings-view .logout-button:hover {
    background-color: #CF6679;
  }

  /* === BOTTOM NAVIGATION === */
  .bottom-nav {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: var(--widget-color);
    border-radius: 999px;
    padding: 10px;
    display: flex;
    gap: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    z-index: 1000;
  }
  .nav-item {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: grid;
    place-items: center;
    cursor: pointer;
    transition: background-color 0.2s ease;
    color: rgba(255, 255, 255, 0.6); /* Inactive icon color */
  }
  .nav-item .material-symbols-outlined {
    -webkit-user-select: none; /* Safari */
    -ms-user-select: none; /* IE 10+ and Edge */
    user-select: none; /* Standard syntax */
    font-size: 28px;
    transition: font-variation-settings 0.2s ease, color 0.2s ease;
    font-variation-settings: 'FILL' 0;
  }
  .nav-item.active {
    background-color: var(--accent-variant-color);
    color: #FFFFFF; /* Active icon color */
  }
  .nav-item.active .material-symbols-outlined {
    font-variation-settings: 'FILL' 1;
  }

  /* === WEEKS BAR (reimagined as dropdown) === */
  #weeks-bar-container {
    margin-bottom: 20px;
    position: relative;
  }
  #week-selector {
    width: 100%;
    padding: 15px 20px;
    background-color: var(--widget-color);
    color: var(--text-color);
    border: none;
    border-radius: var(--border-radius);
    font-size: 1.1rem;
    font-family: var(--font-family);
    appearance: none;
    -webkit-appearance: none;
    cursor: pointer;
    font-weight: 600;
  }

  .empty-placeholder {
    text-align: center;
    color: var(--text-muted-color);
    padding: 40px;
    font-size: 1.1rem;
  }

  @media screen and (max-width: 768px) {
    body {
      padding: 15px 15px 90px 15px;
    }
    .widget-grid {
      grid-template-columns: 1fr;
    }
    header h1 {
      font-size: 1.8rem;
    }
    .bottom-nav {
      width: calc(100% - 30px);
      justify-content: space-around;
      bottom: 15px;
    }
    .nav-item {
      width: 50px;
      height: 50px;
    }
  }
</style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="login-overlay">
  <h1>Weekge</h1>
  <button id="signInBtn">
    <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google logo">
    Sign in with Google
  </button>
</div>

<!-- LOADER -->
<div id="loadingOverlay"><div class="spinner"></div><p>იტვირთება</p></div>

<header>
  <h1 id="page-title">მთავარი</h1>
</header>

<!-- MAIN CONTENT -->
<div class="main-content">
  
  <!-- HOME VIEW -->
  <div id="live-view" class="view active">
    <div id="weeks-bar-container">
      <!-- Weeks dropdown will be generated by JS -->
    </div>
    <div id="home-grid" class="widget-grid">
      <!-- Live Time and Subject cards will be rendered here by JS -->
    </div>
  </div>

  <!-- RESOURCES VIEW -->
  <div id="resources-view" class="view">
    <div id="resources-grid" class="widget-grid">
        <!-- Global resources will be rendered here by JS -->
    </div>
  </div>

  <!-- SETTINGS VIEW -->
  <div id="settings-view" class="view">
    <div id="settings-grid" class="widget-grid">
        <!-- Settings widgets will be rendered here by JS -->
    </div>
  </div>

</div>

<!-- BOTTOM NAVIGATION -->
<div class="bottom-nav">
  <div class="nav-item active" data-view="live-view" data-title="მთავარი">
    <span class="material-symbols-outlined">home</span>
  </div>
  <div class="nav-item" data-view="resources-view" data-title="რესურსები">
    <span class="material-symbols-outlined">widgets</span>
  </div>
  <div class="nav-item" data-view="settings-view" data-title="პარამეტრები">
    <span class="material-symbols-outlined">settings</span>
  </div>
</div>


<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* === UTILITIES === */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const el = (t, p = {}, kids = []) => {
  const e = document.createElement(t);
  Object.assign(e, p);
  kids.forEach(k => e.append(k));
  return e;
};

function setCookie(name, value, days) {
  let expires = "";
  if (days) {
    const date = new Date();
    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
    expires = "; expires=" + date.toUTCString();
  }
  document.cookie = name + "=" + (value || "") + expires + "; path=/";
}

function getCookie(name) {
  const nameEQ = name + "=";
  const ca = document.cookie.split(';');
  for (let i = 0; i < ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) === ' ') c = c.substring(1, c.length);
    if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
  }
  return null;
}

/* === MAIN APP SCRIPT === */
const overlay = $("#loadingOverlay");

fetch("https://raw.githubusercontent.com/WEEKGE/live/main/config.json")
  .then(r => r.json())
  .then(cfg => {
    firebase.initializeApp(cfg);
    startWeekge();
  })
  .catch(() => {
    overlay.innerHTML = "<h2 style='color:red;text-align:center;margin-top:30vh;'>⚠️ config.json ვერ ჩაიტვირთა.</h2>";
  });

function startWeekge() {
  const auth = firebase.auth(), db = firebase.firestore();
  let user = null, catalog = [], selected = [], cache = {}, weekDates = [], userDays = {}, userThemeName = null, lectureDuration = "03:00";
  let currentWeekData = null, selectedWeekNumber = null;

  const daysOfWeek = ["ორშაბათი","სამშაბათი","ოთხშაბათი","ხუთშაბათი","პარასკევი","შაბათი","კვირა"];

  const todayISO = () => new Date().toISOString().slice(0, 10);
  const isBetween = (d, s, e) => d >= s && d <= e;

  const SEMESTER_WEEKS = [
    {n:1,start1:"2025-09-22",end1:"2025-09-28",start2:"2026-03-02",end2:"2026-03-08"},
    {n:2,start1:"2025-09-29",end1:"2025-10-05",start2:"2026-03-09",end2:"2026-03-15"},
    {n:3,start1:"2025-10-06",end1:"2025-10-12",start2:"2026-03-16",end2:"2026-03-22"},
    {n:4,start1:"2025-10-13",end1:"2025-10-19",start2:"2026-03-23",end2:"2026-03-29"},
    {n:5,start1:"2025-10-20",end1:"2025-10-26",start2:"2026-03-30",end2:"2026-04-05"},
    {n:6,start1:"2025-10-27",end1:"2025-11-02",start2:"2026-04-06",end2:"2026-04-12"},
    {n:7,start1:"2025-11-03",end1:"2025-11-09",start2:"2026-04-20",end2:"2026-04-26"},
    {n:8,start1:"2025-11-10",end1:"2025-11-16",start2:"2026-04-27",end2:"2026-05-03"},
    {n:9,start1:"2025-11-17",end1:"2025-11-23",start2:"2026-05-04",end2:"2026-05-10"},
    {n:10,start1:"2025-11-24",end1:"2025-11-30",start2:"2026-05-11",end2:"2026-05-17"},
    {n:11,start1:"2025-12-01",end1:"2025-12-07",start2:"2026-05-18",end2:"2026-05-24"},
    {n:12,start1:"2025-12-08",end1:"2025-12-14",start2:"2026-05-25",end2:"2026-05-31"},
    {n:13,start1:"2025-12-15",end1:"2025-12-20",start2:"2026-06-01",end2:"2026-06-06"}
  ];

  const THEMES = {
    "Default": { bg: "#121212", widget: "#1E1E1E", text: "#fff", accent: "#BB86FC", accentVariant: "#3700B3" },
    "Ocean": { bg: "#0F2027", widget: "#203A43", text: "#fff", accent: "#1488CC", accentVariant: "#2B32B2" },
    "Sunset": { bg: "#2C0A1E", widget: "#4F1C3A", text: "#fff", accent: "#FF8C61", accentVariant: "#C83C66" },
    "Forest": { bg: "#1A2922", widget: "#2E463A", text: "#fff", accent: "#56C271", accentVariant: "#237A41" },
  };

  function applyTheme(themeName) {
    const theme = THEMES[themeName] || THEMES["Default"];
    const root = document.documentElement;
    root.style.setProperty('--bg-color', theme.bg);
    root.style.setProperty('--widget-color', theme.widget);
    root.style.setProperty('--text-color', theme.text);
    root.style.setProperty('--accent-color', theme.accent);
    root.style.setProperty('--accent-variant-color', theme.accentVariant);
    userThemeName = themeName;
  }

  async function saveTheme(themeName) {
    applyTheme(themeName);
    if (user) {
      await db.collection("users").doc(user.uid).set({ userThemeName: themeName }, { merge: true });
    }
    setCookie('userThemeName', themeName, 365);
  }

  async function saveSettings() {
    if (user) {
      await db.collection("users").doc(user.uid).set({ 
        subjects: selected, 
        days: userDays,
        lectureDuration: lectureDuration
      }, { merge: true });
    }
    setCookie('selectedSubjects', JSON.stringify(selected), 365);
    setCookie('userDays', JSON.stringify(userDays), 365);
    setCookie('lectureDuration', lectureDuration, 365);

    // No full boot, just re-render the pages that need updates
    await bootAfterLogin(); // Re-boot to apply changes everywhere
  }

  /* === AUTHENTICATION === */
  auth.onAuthStateChanged(async u => {
    user = u || null;
    try {
      const loginOverlay = $("#login-overlay");
      if (user) {
        loginOverlay.style.display = "none";
        await bootAfterLogin();
      } else {
        loginOverlay.style.display = "flex";
      }
    } catch (error) {
      console.error("Bootstrapping failed:", error);
      overlay.innerHTML = `<h2 style='color:red;text-align:center;margin-top:30vh;'>⚠️ აპლიკაციის ჩატვირთვა ვერ მოხერხდა.</h2><p style='color:var(--text-muted-color)'>${error.message}</p>`;
    } finally {
      // Always hide the main loader, regardless of success or failure
      overlay.classList.add("hidden");
    }
  });

  $("#signInBtn").onclick = async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      await auth.signInWithPopup(provider);
    } catch (err) {
      console.error("Sign-in error:", err);
      alert("Sign-in failed. Please try again.");
    }
  };

  /* === APP BOOTSTRAP === */
  async function bootAfterLogin() {
    await loadData();
    flattenWeeks();
    initCurrentWeek();
    
    renderWeeksBar();
    renderHomePage();
    renderResourcesPage();
    renderSettingsPage();
    
    initLiveTime();
    initNavigation();
  }

  async function loadData() {
    // Load catalog
    const catalogSnap = await db.collection("subjects").get();
    catalog = catalogSnap.docs.map(d => ({ id: d.id, ...d.data() }));

    // Load user data
    let data = {};
    if (user) {
      const userSnap = await db.collection("users").doc(user.uid).get();
      data = userSnap.exists ? userSnap.data() : {};
    } else {
      // Fallback to cookies if not logged in
      data.subjects = JSON.parse(getCookie('selectedSubjects') || '[]');
      data.days = JSON.parse(getCookie('userDays') || '{}');
      data.userThemeName = getCookie('userThemeName') || "Default";
      data.lectureDuration = getCookie('lectureDuration') || "03:00";
    }

    selected = data.subjects || [];
    userDays = data.days || {};
    userThemeName = data.userThemeName || "Default";
    applyTheme(userThemeName);

    lectureDuration = data.lectureDuration || "03:00";
    // Ensure subjects are in cache
    const toLoad = selected.filter(id => !cache[id]);
    for (const id of toLoad) {
      const subj = catalog.find(c => c.id === id);
      if (subj) cache[id] = subj;
    }
  }

  function flattenWeeks() {
    weekDates = [];
    SEMESTER_WEEKS.forEach(w => {
      if (w.start1) weekDates.push({ n: w.n, start: w.start1, end: w.end1 });
      if (w.start2) weekDates.push({ n: w.n, start: w.start2, end: w.end2 });
    });
  }

  function initCurrentWeek() {
    const iso = todayISO();
    currentWeekData = weekDates.find(w => isBetween(iso, w.start, w.end)) || weekDates[0];
    selectedWeekNumber = currentWeekData ? currentWeekData.n : (weekDates.length > 0 ? weekDates[0].n : 1);
  }

  /* === NAVIGATION === */
  function initNavigation() {
    const navItems = $$('.nav-item');
    const views = $$('.view');
    const pageTitle = $('#page-title');

    navItems.forEach(item => {
      item.addEventListener('click', () => {
        const viewId = item.dataset.view;
        
        navItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');

        views.forEach(v => v.classList.remove('active'));
        $(`#${viewId}`).classList.add('active');

        pageTitle.textContent = item.dataset.title;
      });
    });
  }

  /* === LIVE TIME WIDGET === */
  function initLiveTime() {
    const timeEl = el('div', { className: 'time' });
    const dateEl = el('div', { className: 'date' });
    const timeCard = el('div', { id: 'live-time-card', className: 'widget-card' }, [timeEl, dateEl]);
    
    $('#home-grid').prepend(timeCard);

    function updateTime() {
      const now = new Date();
      timeEl.textContent = now.toLocaleTimeString('ka-GE', { hour: '2-digit', minute: '2-digit' });
      dateEl.textContent = now.toLocaleDateString('ka-GE', { weekday: 'long', month: 'long', day: 'numeric' });
    }
    updateTime();
    setInterval(updateTime, 1000);
  }

  /* === WEEKS BAR / SELECTOR === */
  function renderWeeksBar() {
    const container = $('#weeks-bar-container');
    container.innerHTML = '';

    const select = el('select', { id: 'week-selector' });
    SEMESTER_WEEKS.forEach(w => {
      const isCurrent = currentWeekData && w.n === currentWeekData.n;
      const option = el('option', { 
        value: w.n, 
        textContent: `კვირა ${w.n}` + (isCurrent ? ' (მიმდინარე)' : '')
      });
      if (w.n === selectedWeekNumber) {
        option.selected = true;
      }
      select.append(option);
    });

    select.addEventListener('change', (e) => {
      selectedWeekNumber = parseInt(e.target.value, 10);
      renderHomePage();
    });

    container.append(select);
  }

  /* === RENDERING FUNCTIONS === */

  function getEmbedIcon(type) {
    switch (type?.toLowerCase()) {
      case 'slide': return 'slideshow';
      case 'video': return 'play_circle';
      case 'book': return 'menu_book';
      default: return 'link';
    }
  }

  function createEmbedLinks(buttons) {
    const container = el('div', { className: 'embed-links' });
    if (!buttons || buttons.length === 0) return container;

    buttons.forEach(b => {
      const isCustom = b.type === 'custom';
      const iconCircleClass = isCustom ? 'icon-circle is-custom' : 'icon-circle';
      const linkClass = isCustom ? 'embed-link is-custom' : 'embed-link';

      const link = el('a', {
        className: linkClass,
        href: b.link || '#',
        target: '_blank',
        title: b.label
      }, [
        el('div', { className: iconCircleClass }, [
          el('span', { className: 'material-symbols-outlined', textContent: getEmbedIcon(b.type) }),
          ...(isCustom ? [el('span', { className: 'label', textContent: b.label })] : [])
        ])
      ]);
      container.append(link);
    });
    return container;
  }

  function renderHomePage() {
    const grid = $('#home-grid');
    // Clear only subject cards, not the time widget
    $$('#home-grid .subject-card').forEach(card => card.remove());

    const todayDayIndex = new Date().getDay() === 0 ? 6 : new Date().getDay() - 1;

    const subjectsForWeek = selected.map(id => {
        const [hours, minutes] = lectureDuration.split(':').map(Number);
        const lectureDurationMs = (hours * 60 * 60 * 1000) + (minutes * 60 * 1000);

        const now = new Date();
        const isSelectedWeekCurrent = selectedWeekNumber === (currentWeekData ? currentWeekData.n : -1);



        const subj = cache[id];
        if (!subj) return null;
        const dayData = userDays?.[id] ?? { day: null, time: null };
        return {
            ...subj,
            dayIndex: daysOfWeek.indexOf(dayData.day),
            time: dayData.time
        };
    }).filter(Boolean);

    // Simple sort: upcoming first, then by day index
    subjectsForWeek.sort((a, b) => {
        const isAUpcoming = a.dayIndex >= todayDayIndex;
        const isBUpcoming = b.dayIndex >= todayDayIndex;
        if (isAUpcoming !== isBUpcoming) return isAUpcoming ? -1 : 1;
        return a.dayIndex - b.dayIndex;
    });

    if (subjectsForWeek.length === 0) {
        if (!$('.empty-placeholder')) {
            grid.append(el('p', {className: 'empty-placeholder', textContent: 'საგნები არ არის არჩეული. დაამატე პარამეტრებიდან.'}));
        }
        return;
    } else {
        const placeholder = $('.empty-placeholder');
        if (placeholder) placeholder.remove();
    }

    subjectsForWeek.forEach(subj => {
      const weekData = subj.weeks?.find(w => w.week === selectedWeekNumber -1);
      if (!weekData || !weekData.topic) return; // Only show subjects with content for the week

      const card = el('div', { className: 'widget-card subject-card' }, [
        el('h3', { className: 'widget-title', textContent: subj.name }),
        el('p', { className: 'widget-subtitle', textContent: weekData.type || 'ლექცია' }),
        el('div', { className: 'topic', innerHTML: weekData.topic }),
        createEmbedLinks(weekData.buttons)
      ]);
      grid.append(card);
    });
  }

  function renderResourcesPage() {
    const grid = $('#resources-grid');
    grid.innerHTML = '';

    const subjectsWithGlobalButtons = selected
        .map(id => cache[id])
        .filter(subj => subj && subj.globalButtons && subj.globalButtons.length > 0);

    if (subjectsWithGlobalButtons.length === 0) {
        grid.append(el('p', {className: 'empty-placeholder', textContent: 'არჩეულ საგნებს არ აქვს გლობალური რესურსები.'}));
        return;
    }

    subjectsWithGlobalButtons.forEach(subj => {
      const card = el('div', { className: 'widget-card' }, [
        el('h3', { className: 'widget-title', textContent: subj.name }),
        createEmbedLinks(subj.globalButtons)
      ]);
      grid.append(card);
    });
  }

  function renderSettingsPage() {
    const grid = $('#settings-grid');
    grid.innerHTML = '';

    // Create containers for the 2/3 + 1/3 layout
    const subjectsContainer = el('div', { className: 'subjects-widget-container' });
    const sideContainer = el('div', { className: 'side-widget-container' });

    // -- My Subjects Widget --
    const mySubjectsContent = el('div', { className: 'settings-widget-content' });
    const sortedSelected = selected
      .map(id => cache[id])
      .filter(Boolean)
      .sort((a, b) => a.name.localeCompare(b.name));

    const lectureStartTimes = ["09:00", "11:20", "13:40", "16:00", "18:20"];
    const dayAbbreviations = ["ორშ", "სამ", "ოთხ", "ხუთ", "პარ", "შაბ", "კვ"];

    sortedSelected.forEach(subj => {
      const currentDay = userDays[subj.id]?.day;

      const timeSelect = el('select', { className: 'day-time-select' });
      lectureStartTimes.forEach(time => {
        const opt = el('option', { value: time, textContent: time });
        if (userDays[subj.id]?.time === time) opt.selected = true;
        timeSelect.append(opt);
      });
      timeSelect.onchange = () => {
        if (!userDays[subj.id]) userDays[subj.id] = { day: null, time: null };
        userDays[subj.id].time = timeSelect.value;
        markDirty();
      };

      const weekdayContainer = el('div', { className: 'weekday-chooser' });
      daysOfWeek.forEach((day, index) => {
        const dayBtn = el('button', {
          className: 'weekday-btn',
          textContent: dayAbbreviations[index],
          title: day
        });
        if (currentDay === day) {
          dayBtn.classList.add('active');
        }
        dayBtn.onclick = () => {
          if (!userDays[subj.id]) userDays[subj.id] = { day: null, time: null };
          
          // Toggle behavior
          if (userDays[subj.id].day === day) {
            userDays[subj.id].day = null; // Deselect
          } else {
            userDays[subj.id].day = day; // Select
          }
          
          markDirty();
          renderSettingsPage(); // Re-render to show active state change
        };
        weekdayContainer.append(dayBtn);
      });

      const removeBtn = el('button', { className: 'action-btn remove' }, [
        el('span', { className: 'material-symbols-outlined', textContent: 'remove' })
      ]);
      removeBtn.onclick = () => {
        selected = selected.filter(id => id !== subj.id);
        delete userDays[subj.id];
        markDirty();
        renderSettingsPage();
      };

      const item = el('div', { className: 'settings-item', style: 'position: relative; padding-right: 46px;' }, [
        el('div', { className: 'name', textContent: subj.name, style: 'width: 100%; margin-bottom: 5px;' }),
        timeSelect,
        weekdayContainer,
        removeBtn,
      ]);
      mySubjectsContent.append(item);
    });

    const saveButton = el('button', { 
        className: 'save-button', 
        textContent: 'ცვლილებების დამახსოვრება',
        style: 'margin-top: auto; padding-top: 10px;'
    });
    saveButton.onclick = saveSettings;

    const mySubjectsCard = el('div', { id: 'my-subjects-widget', className: 'widget-card' }, [
      el('h3', { className: 'widget-title', textContent: 'ჩემი საგნები' }),
      mySubjectsContent,
      saveButton
    ]);

    // -- Subjects Catalog Widget --
    const catalogContent = el('div', { className: 'settings-widget-content' });
    const sortedCatalog = [...catalog].sort((a, b) => a.name.localeCompare(b.name));

    sortedCatalog.forEach(subj => {
      if (selected.includes(subj.id)) return; // Don't show already added subjects

      const addBtn = el('button', { className: 'action-btn' }, [
        el('span', { className: 'material-symbols-outlined', textContent: 'add' })
      ]);
      addBtn.onclick = () => {
        selected.push(subj.id);
        markDirty();
        renderSettingsPage(); // Re-render to move subject to "My Subjects"
      };

      catalogContent.append(el('div', { className: 'settings-item' }, [
        el('div', { className: 'name', textContent: subj.name }),
        addBtn
      ]));
    });

    const catalogCard = el('div', { className: 'widget-card' }, [
      el('h3', { className: 'widget-title', textContent: 'საგნების კატალოგი' }),
      catalogContent
    ]);

    subjectsContainer.append(mySubjectsCard, catalogCard);

    // -- Lecture Duration Widget --
    const durationCard = createDurationWidget();
    sideContainer.append(durationCard);

    // -- Theme Selector Widget --
    const themeCard = createThemeWidget();
    sideContainer.append(themeCard);

    // -- Logout Widget --
    const logoutCard = createLogoutWidget();
    sideContainer.append(logoutCard);

    grid.append(subjectsContainer, sideContainer);
  }

  function createDurationWidget() {
    const [initialHour, initialMinute] = lectureDuration.split(':');

    const hourSelect = el('select', { className: 'day-time-select' });
    for (let i = 0; i <= 4; i++) {
      hourSelect.append(el('option', { value: i, textContent: `${i} სთ`, selected: i == initialHour }));
    }

    const minuteSelect = el('select', { className: 'day-time-select' });
    for (let i = 0; i <= 55; i += 5) {
      minuteSelect.append(el('option', { value: i, textContent: `${i} წთ`, selected: i == initialMinute }));
    }

    const updateDuration = () => {
      lectureDuration = `${hourSelect.value}:${minuteSelect.value}`;
      markDirty();
    };
    hourSelect.onchange = updateDuration;
    minuteSelect.onchange = updateDuration;

    const container = el('div', { style: 'display: flex; gap: 10px; margin-top: 10px;' }, [hourSelect, minuteSelect]);
    return el('div', { className: 'widget-card' }, [
      el('h3', { className: 'widget-title', textContent: 'ლექციის ხანგრძლივობა' }),
      container
    ]);
  }

  function createThemeWidget() {
    // Theme Selector Widget
    const themeOptions = Object.keys(THEMES).map(themeName => {
        const theme = THEMES[themeName];
        const option = el('div', { className: 'theme-option', style: 'cursor: pointer;' }, [
            el('div', { className: 'name', textContent: themeName }),
            el('div', { className: 'swatches' }, [
                el('div', { className: 'swatch', style: `background-color: ${theme.bg}` }),
                el('div', { className: 'swatch', style: `background-color: ${theme.widget}` }),
                el('div', { className: 'swatch', style: `background-color: ${theme.accent}` }),
            ])
        ]);
        if (themeName === userThemeName) {
            option.classList.add('active');
        }
        option.onclick = () => {
            saveTheme(themeName);
            // Re-render to show active state
            renderSettingsPage();
        };
        return option;
    });

    return el('div', { className: 'widget-card theme-selector' }, [
      el('h3', { className: 'widget-title', textContent: 'თემის არჩევა' }),
      el('div', { className: 'themes' }, themeOptions)
    ]);
  }

  function createLogoutWidget() {

    // Logout Widget
    const logoutButton = el('button', {
        className: 'logout-button',
        textContent: 'გასვლა'
    });
    logoutButton.onclick = async () => {
        try {
            await auth.signOut();
            location.reload();
        } catch (error) {
            console.error("Error signing out:", error);
        }
    };
    return el('div', { className: 'widget-card' }, [logoutButton]);
  }

  function markDirty() {
    // In this new design, we can show a visual indicator or just save directly.
    const saveBtn = $('.save-button');
    if (saveBtn) saveBtn.style.backgroundColor = 'var(--accent-color)';
  }
}
</script>
</body>
</html>
