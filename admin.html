<!DOCTYPE html>
<html lang="ka">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin - shemdeg</title>
<link rel="icon" href="/icons/shicon.png">

<!-- SEO META -->
<meta name="description" content="Weekge Admin Panel â€” Manage university syllabus subjects, weeks, slides and videos.">
<meta name="keywords" content="weekge, week, weekge admin, syllabus editor, study admin, ug, university admin">
<meta name="author" content="weekge">
<meta name="theme-color" content="#0B1216">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wght@100..900&display=swap');

:root{
  --bg:#121212; --surface:#202020; --surface2:#161616; --text:#EDEFF2;
  --accent:#6e6e6e; --success:#ffffff; --danger:#f12525;
  --buttontext:#ffffff;--field:#ffffff09;
}

/* Scrollbar */
::-webkit-scrollbar{width:.35rem}
::-webkit-scrollbar-thumb{background:#16b438}

/* Base */
*{box-sizing:border-box;margin:0;padding:0;font-family: "Noto Sans Georgian", sans-serif;}
img[src$="\.svg"] {
  filter: invert(1);
}
body{background:var(--bg);color:var(--text);height:100vh;display:grid;grid-template-rows:64px 1fr;overflow:hidden;}

  /* === Loading Overlay === */
  #loadingOverlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: #0B1216;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: opacity .3s ease, visibility .3s ease;
  }
  #loadingOverlay.hidden {
    opacity: 0;
    visibility: hidden;
  }
  #loadingOverlay .spinner {
    width: 100px;
    height: 100px;
    border: 10px solid rgba(255,255,255,.15);
    border-top: 10px solid var(--accent);
    border-radius: 50%;
    animation: spin 0.3s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  #loadingOverlay p {
    margin-top: 16px;
    opacity: .9;
  }

/* Header */
header{background:var(--surface);display:flex;align-items:center;justify-content:space-between;padding:0 16px;border-bottom:1px solid #0006;}
header h1{font-size:1.8rem;color:var(--accent);font-weight:700;pointer-events: none;user-select: none;}
header .right{display:flex;align-items:center;gap:12px;}
header button{transition: ease 0.1s;background:var(--accent);color:var(--buttontext);border:none;padding:8px 16px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px;border-radius:0;}
header button img{width:18px;height:18px;}
header button:hover{background-color: var(--accent);}
#saveStatus{font-weight:600;font-size:18px; margin-right:30px;pointer-events: none;user-select: none;}
#saveStatus.saving{color:#ffc423}
#saveStatus.saved{color:var(--success);}
#saveStatus.error{color:var(--danger);}

/* Layout (3-panel) */
main{display:grid;grid-template-columns:320px 240px 1fr;height:calc(100vh - 64px);}
.panel{background:#131313;border-right:1px solid #0006;display:flex;flex-direction:column;overflow:hidden;}
.panel-content{flex:1;overflow-y:auto;padding:10px;}
#editorPanel{overflow-y:auto;height:100%;padding:20px 50px;}

/* Panel 1: Subjects */
.search{width:100%;padding:10px;border:none;background:var(--surface);color:#fff;margin-bottom:10px;}
.subject-item{user-select: none;padding:10px;background:#ffffff18;border:1px solid #0006;margin-bottom:8px;cursor:pointer;font-weight:600; transition: ease-out 0.1s;}
.subject-item:hover{background:#ffffff22;}
.subject-item.active{background:var(--accent);color:#fff;}
.subject-symbol-square {
  width: 30px;
  height: 30px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border: 1px solid var(--field);
  background-color: var(--field);
  margin-right: 8px;
  vertical-align: middle;
  font-size: 1.2em;
}
.btn-row{display:flex;gap:10px;margin-top:auto;padding:10px;}
.btn-row button{flex:1;padding:10px;background:var(--accent);color:#ffffff;border:none;cursor:pointer;font-weight:700;display:flex;align-items:center;justify-content:center;gap:8px;}
.btn-row button img{width:20px;height:20px}

/* Panel 2: Weeks */
#weeksPanel { background: #181818; }
.week-item {
    padding: 12px 16px;
    font-weight: 600;
    cursor: pointer;
    border-bottom: 1px solid #222;
    transition: background .15s ease;
}
.week-item:hover { background: #ffffff18; }
.week-item.active { background: var(--accent); color: #fff; }
.week-item.global { font-weight: 700; color: var(--success); }

.btnLabel{margin: 0;}
.btnLink{margin: 0;}

/* Panel 3: Editor */
#editor.fadeout{opacity:0;filter:blur(4px);transition:opacity .1s ease, filter .1s ease;}
#editor h2{font-size:1.5rem;margin-bottom:16px;color:var(--accent);}
label{display:block;font-weight:700;margin:16px 0 4px;}
input,select{width:100%;padding:10px;border:none;background:var(--field);color:var(--buttontext);font-size:1rem;margin-bottom:10px;}
.symbol-selector {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 0;
}
#subjectSymbolDisplay {
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid var(--field);
  font-size: 2.2rem;
  background-color: var(--field);
  color: var(--buttontext);
  user-select: none;
}

.material-symbols-outlined {
  font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 48;
}

#subjectSymbolName{height: 60px;margin-top: 10px;font-size: 1.4rem;}

.week{border:1px solid #0006;background:#141414;padding:18px;margin-bottom:44px;}
.week h3{margin-bottom:1rem;color:var(--accent);font-size: 1.5rem;}
.addBtn{transition: 0.2s ease;font-size: 1rem;background:var(--accent);color:var(--buttontext);border:none;padding:10px 20px;cursor:pointer;margin-top:8px;display:inline-flex;align-items:center;gap:6px;}
.addBtn:hover{background-color: #14862d;}

.success{background:var(--success);color:var(--buttontext)}
.danger{background:var(--danger);color:var(--buttontext);padding: 20px 0;}
.status{text-align:center;margin-top:10px;}
.global{border:0;background:#141414;padding:20px;margin: 40px 0;}
.global h3{color:var(--success);margin-bottom:6px;}

/* Color selector */
.colorPalette{display:flex;gap:5px;align-items:center;margin-left:10px;}

.colorBox{width:35px;height:35px;border:0;cursor:pointer;transition:.2s ease;filter:brightness(.95);border:rgba(255,255,255,0) 0.2rem solid}
.colorBox[data-color="yellow"]{background:#ffb20b;}
.colorBox[data-color="green"]{background:#1fc909;}
.colorBox[data-color="red"]{background:#ff1f1f;}
.colorBox[data-color="blue"]{background:#1168ff;}
.colorBox.active{border:rgb(255, 255, 255) 0.2rem solid;box-sizing:border-box;}

/* Popup (Create Subject) */
#addPopup{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;z-index:2000;}
#addPopup.active{display:flex;animation:popupIn .18s ease;}
@keyframes popupIn{from{opacity:0;filter: blur(20px);}to{opacity:1;}}
.popup-box{background:#121A1F;border:1px solid #0006;width:min(92vw,420px);padding:18px 16px;border-radius:0px;box-shadow:0 10px 40px rgba(0,0,0,.5);}
.popup-box h3{color:var(--accent);margin-bottom:10px;text-align:center;}
.popup-box .row{display:grid;gap:6px;margin:8px 0;}
.popup-box input{width:100%;padding:10px;border:none;background:#23343B;color:#fff;}
.popup-actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;}
.popup-actions button{padding:10px;border:none;font-weight:800;cursor:pointer}
.createBtn{background:var(--accent);color:#ffffff}
.cancelBtn{background:#333;color:#fff}

.removeBtn {
  background: #e61717;
  color: #fff;
  border: none;
  padding: 0;
  margin: 0 0 0 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 0;
  transition: 0.2s ease;
  font-weight: 500;
  font-size: 1rem;
  min-width: 35px;
  height: 35px;
}

.removeBtn:hover {
  background: #920c0c;
}

.removeBtn img {
  width: 18px;
  height: 18px;
  pointer-events: none;
}
.topicField {
  width: 100%;
  min-height: 100px;
  max-height: 300px;
  overflow-y: auto;
  background: var(--field);
  color: var(--buttontext);
  padding: 10px;
  font-size: 1rem;
  border: none;
  outline: none;
  white-space: pre-wrap;
  word-wrap: break-word;
  line-height: 1.5;
  border-radius: 4px;
}
.topicField:focus {
  background: #303840;
}
.delete-progress {
  position:absolute;
  left:0;
  top:0;
  width:0%;
  height:100%;
  background-color:rgb(185, 0, 0);
  pointer-events:none;
  transition:none;
  z-index: -1;
}

#deleteNavBtn{background-color: #ff2e2e;transition: 0.1 ease;user-select: none;}
#deleteNavBtn:hover{transform: scale(1.02);}

#logoutBtn{background-color: #383838;transition: 0.1 ease;user-select: none;}
#logoutBtn:hover{transform: scale(1.02);}

#applyNavBtn{background-color: #47da1a;transition: 0.1 ease;user-select: none;}
#applyNavBtn:hover{transform: scale(1.02);}

.customBtnRow {
    position: relative;
    display: flex;
    align-items: center;
    gap: 8px;
    padding-left: 40px;
    margin-top: 20px;
    margin-bottom: 20px;
}

.drag-handle {
    position: absolute;
    top: 50%;
    left: 0;
    transform: translateY(-50%);
    cursor: grab;
    padding: 0 10px;
    color: #fff;
    font-size: 1.2rem;
}

.topicField{width:100%;min-height:100px;max-height:300px;overflow-y:auto;background:var(--field);color:var(--buttontext);padding:10px;font-size:1rem;border:none;outline:none;white-space:pre-wrap;word-wrap:break-word;line-height:1.5;border-radius:4px;}
.topicField:focus{background:#303840;}

.image-upload-container {
  margin-bottom: 10px;
  border: 2px dashed var(--field);
  padding: 20px;
  text-align: center;
  cursor: pointer;
  position: relative;
  min-height: 150px; /* Minimum height for drop zone */
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: var(--surface2);
}

.image-upload-container.drag-over {
  border-color: var(--accent);
  background-color: #2a2a2a;
}

.drop-zone {
  color: var(--text);
  opacity: 0.7;
}

.drop-zone .click-to-upload {
  color: var(--accent);
  font-weight: bold;
}

.image-preview {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.image-preview img {
  width: 100%;
  height: 100%;
  object-fit: contain; /* Ensures the image is contained within the element, maintaining its aspect ratio */
  object-position: center; /* Centers the image */
}

.delete-image-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  background-color: rgba(255, 0, 0, 0.7);
  color: white;
  border: none;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 1.2rem;
  line-height: 1;
  padding: 0;
  transition: background-color 0.2s ease;
}

.delete-image-btn:hover {
  background-color: rgba(255, 0, 0, 1);
}

.delete-image-btn .material-symbols-outlined {
  font-size: 18px;
}

.template-btn {
    flex: 1;
    padding: 10px;
    background: #3a3a3a;
    color: #fff;
    border: 1px solid #555;
    cursor: pointer;
    font-weight: 600;
    transition: background .2s ease;
}
.template-btn:hover {
    background: #4a4a4a;
}
/* Mobile */
@media(max-width:900px){
  main{grid-template-columns:1fr}
  #subjectsPanel{order:2}
  #weeksPanel{order:3}
  #editorPanel{order:1;padding:18px}
  .customBtnRow{flex-wrap: wrap;}
  .colorPalette{grid-column:1 / -1}
}
</style>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
</head>
<body>

<!-- Sign-in Overlay -->
<div id="signin-overlay" style="display: none; position: fixed; inset: 0; background: var(--bg); z-index: 10000; flex-direction: column; align-items: center; justify-content: center;">
  <h1 style="font-size: 3rem; color: var(--accent); margin-bottom: 20px;">Weekge Admin</h1>
  <button id="googleSignInBtn" style="background: #fff; color: #000; border: none; padding: 15px 30px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; gap: 10px;">
    <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google logo" style="height: 24px;">
    Sign in with Google
  </button>
</div>

<!-- Loading -->
<div id="loadingOverlay">
  <div class="spinner"></div>
  <p>áƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ”áƒ‘áƒ...</p>
</div>

<header>
  <h1>Weekge Admin</h1>
  <div class="right">
    <div id="saveStatus" class="saved">âœ… áƒ“áƒáƒ›áƒáƒ®áƒ¡áƒáƒ•áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ</div>

    <!-- NAV: Apply / Delete -->
    <button id="applyNavBtn" title="Ctrl + S">
      <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/check.svg" style="color: white;" alt="">Apply
    </button>
    <button id="deleteNavBtn">
      <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/delete.svg" alt="">Delete
    </button>

    <!-- Auth -->
    <button id="signinBtn">
      <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/check.svg" alt="">Google-áƒ˜áƒ— áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ
    </button>
    <button id="logoutBtn" style="display:none;">
      <img src="https://github.com/WEEKGE/live/raw/refs/heads/main/svgs/logout.svg" alt="">áƒ’áƒáƒ¡áƒ•áƒšáƒ
    </button>
  </div>
</header>

<main>
  <aside id="subjectsPanel" class="panel">
    <div class="panel-content">
      <input type="search" id="searchBox" class="search" placeholder="áƒ›áƒáƒ«áƒ”áƒ‘áƒœáƒ">
      <div id="subjectList"></div>
    </div>
    <div class="btn-row">
      <button id="addSubjectBtn">
        <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" alt="">áƒ¡áƒáƒ’áƒœáƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ
      </button>
    </div>
  </aside>

  <aside id="weeksPanel" class="panel" style="display:none;">
    <div id="weeksList" class="panel-content" style="padding:0;"></div>
  </aside>

  <section id="editorPanel">
    <h2 id="editorTitle">áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ¡áƒáƒ’áƒáƒœáƒ˜ áƒ’áƒáƒ“áƒáƒ¡áƒáƒ™áƒ”áƒ—áƒ”áƒ‘áƒšáƒáƒ“</h2>
    <div id="editor"></div>
  </section>
</main>

<!-- Create Subject Popup -->
<div id="addPopup">
  <div class="popup-box">
    <h3>ğŸ†• áƒáƒ®áƒáƒšáƒ˜ áƒ¡áƒáƒ’áƒáƒœáƒ˜</h3>
    <div class="row">
      <label for="popupName">áƒ¡áƒáƒ’áƒœáƒ˜áƒ¡ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜</label>
      <input id="popupName" placeholder="áƒ›áƒáƒ’: Microeconomics" />
    </div>
    <div class="row">
      <label for="popupId">ID</label>
      <input id="popupId" placeholder="ECON1234" />
    </div>
    <div class="popup-actions">
      <button class="cancelBtn" id="popupCancel">Cancel</button>
      <button class="createBtn" id="popupCreate">Create</button>
    </div>
  </div>
</div>

<script>
const overlay = document.getElementById("loadingOverlay");

/* === Firebase init from external config === */
fetch("https://raw.githubusercontent.com/WEEKGE/live/main/config.json")
  .then(r => r.json())
  .then(cfg => { 
    firebase.initializeApp(cfg); 
    startAdmin(); 
  })
  .catch(() => {
    document.body.innerHTML = "<h2 style='color:red;text-align:center;margin-top:30vh;'>âš ï¸ áƒ‘áƒáƒ–áƒ áƒ•áƒ”áƒ  áƒ©áƒáƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ.</h2>";
  });

function startAdmin(){
  const auth = firebase.auth(), db = firebase.firestore();
  let user = null, subjects = [], currentSubjectData = null, draftSubjectData = null, currentId = null, currentWeek = null;
  let isDirty = false;

  // Obfuscated admin email to prevent scraping. It's decoded at runtime.
  const ADMIN_EMAILS = [atob("ZGF2aXQuZ3Zha2hhcmlhQGdtYWlsLmNvbQ==")];
  const $ = s => document.querySelector(s);
  const el = (t, p = {}, kids = []) => { const e = document.createElement(t); Object.assign(e, p); kids.forEach(k => e.append(k)); return e; };

  const saveStatus = $("#saveStatus");
  const editorContainer = $("#editor");

  const setSaveState = (state, msg) => {
    saveStatus.className = "";
    if(state === "wait"){
      saveStatus.textContent = "â³ áƒ›áƒáƒ˜áƒ—áƒ›áƒ˜áƒœáƒ”...";
      saveStatus.classList.add("wait");
    }else if(state === "saved"){
      saveStatus.textContent = "âœ… áƒ“áƒáƒ›áƒáƒ®áƒ¡áƒáƒ•áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ";
      saveStatus.classList.add("saved");
      isDirty = false;
    }else if(state === "error"){
      saveStatus.textContent = "âŒ áƒáƒ áƒáƒ‘áƒšáƒ”áƒ›áƒáƒ";
      saveStatus.classList.add("error");
    }else if(state === "dirty"){
      saveStatus.textContent = "âš ï¸ áƒ¨áƒ”áƒœáƒáƒ®áƒ£áƒšáƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡";
      saveStatus.classList.add("dirty");
    }else{
      if(msg) saveStatus.textContent = msg;
    }
  };

  const markDirty = () => {
    isDirty = true;
    setSaveState("dirty");
  };

  // Image Upload Functionality (scoped within createButtonEditor)
  let currentImageUrl = "";

  function setupImageUpload(container) {
      const imageUploadContainer = container.querySelector(".image-upload-container");
      if (!imageUploadContainer) return;

      const imageInput = imageUploadContainer.querySelector("input[type=file]");
      const dropZone = imageUploadContainer.querySelector(".drop-zone");
      const imagePreview = imageUploadContainer.querySelector(".image-preview");
      const uploadedImage = imageUploadContainer.querySelector(".uploaded-image");
      const deleteImageBtn = imageUploadContainer.querySelector(".delete-image-btn");

      function displayImage(file) {
          if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                  uploadedImage.src = e.target.result;
                  imagePreview.style.display = "flex";
                  dropZone.style.display = "none";
                  currentImageUrl = e.target.result;
                  markDirty();
              };
              reader.readAsDataURL(file);
          }
      }

      function clearImage() {
          uploadedImage.src = "";
          imagePreview.style.display = "none";
          dropZone.style.display = "flex";
          currentImageUrl = "";
          markDirty();
      }

      function handleFile(file) {
          if (file && file.type.startsWith("image/")) {
              displayImage(file);
          } else {
              alert("Please upload an image file.");
          }
      }

      dropZone.addEventListener("dragover", (e) => { e.preventDefault(); imageUploadContainer.classList.add("drag-over"); });
      dropZone.addEventListener("dragleave", () => { imageUploadContainer.classList.remove("drag-over"); });
      dropZone.addEventListener("drop", (e) => {
          e.preventDefault();
          imageUploadContainer.classList.remove("drag-over");
          handleFile(e.dataTransfer.files[0]);
      });
      dropZone.addEventListener("click", () => imageInput.click());
      imageInput.addEventListener("change", (e) => handleFile(e.target.files[0]));
      deleteImageBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          if (confirm("Are you sure you want to delete this image?")) clearImage();
      });

      // Initial state
      if (currentSubjectData && currentSubjectData.imageUrl) {
          uploadedImage.src = currentSubjectData.imageUrl;
          imagePreview.style.display = "flex";
          dropZone.style.display = "none";
          currentImageUrl = currentSubjectData.imageUrl;
      } else {
          clearImage();
      }
  }

  /* === Auth === */
  $("#googleSignInBtn").onclick = async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    try { await auth.signInWithPopup(provider); } 
    catch (err) { console.error("Sign-in error:", err); alert("Sign-in failed."); }
  };

  $("#logoutBtn").onclick = () => auth.signOut();

  auth.onAuthStateChanged(async u => {
    user = u || null;
    const signinOverlay = $("#signin-overlay");
    if(user){
      signinOverlay.style.display = "none";
      $("#signinBtn").style.display = "none";
      $("#logoutBtn").style.display = "inline-flex";

      if(ADMIN_EMAILS.includes(user.email)){
        overlay.querySelector("p").textContent = "áƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ”áƒ‘áƒ...";
        await loadSubjects();
        setTimeout(() => overlay.classList.add("hidden"), 300);
      }else{
        overlay.innerHTML = "<div style='text-align: center;'><h1 style='color:red;'>ğŸš« Access Denied</h1><button id='accessDeniedLogoutBtn' style='background: #333; color: #fff; border: none; padding: 10px 20px; margin-top: 20px; cursor: pointer;'>Log Out</button></div>";
        $("#accessDeniedLogoutBtn").onclick = () => auth.signOut();
        overlay.classList.remove("hidden");
      }
    }else{
      signinOverlay.style.display = "flex";
      overlay.classList.add("hidden");
      $("#signinBtn").style.display = "none"; // Should be hidden anyway
      $("#logoutBtn").style.display = "none";
      $("#weeksPanel").style.display = "none";
      editorContainer.innerHTML = "";
      $("#editorTitle").textContent = "áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ¡áƒáƒ’áƒáƒœáƒ˜ áƒ’áƒáƒ“áƒáƒ¡áƒáƒ™áƒ”áƒ—áƒ”áƒ‘áƒšáƒáƒ“";
    }
  });

  /* === Subjects === */
  async function loadSubjects(){
    const snap = await db.collection("subjects").get();
    subjects = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderSubjectList();
  }

  function renderSubjectList(){
    const list = $("#subjectList"); 
    list.innerHTML = "";
    const q = $("#searchBox").value.toLowerCase();
    subjects
      .filter(s => (s.name||"").toLowerCase().includes(q) || (s.id||"").toLowerCase().includes(q))
      .forEach(s => {
        const div = el("div",{ className:"subject-item" });
        const symbolSquare = el("span", { className: "subject-symbol-square material-symbols-outlined", textContent: s.theme || "" });
        if (!s.theme) symbolSquare.style.visibility = "hidden";
        div.append(symbolSquare, `${s.name} (${s.id})`);
        div.onclick = () => openSubject(s.id);
        if(s.id === currentId) div.classList.add("active");
        list.append(div);
      });
  }
  $("#searchBox").oninput = renderSubjectList;

  /* === Popup create === */
  const popup = $("#addPopup");
  $("#addSubjectBtn").onclick = () => { 
    $("#popupName").value = ""; 
    $("#popupId").value = ""; 
    popup.classList.add("active"); 
    $("#popupName").focus(); 
  };
  $("#popupCancel").onclick = () => popup.classList.remove("active");
  $("#popupCreate").onclick = createSubject;
  $("#popupId").addEventListener("keydown", e => { if(e.key === "Enter") createSubject(); });

  async function createSubject(){
    const name = $("#popupName").value.trim();
    const id = $("#popupId").value.trim();
    if(!name || !id){ alert("áƒ¨áƒ”áƒ˜áƒ§áƒ•áƒáƒœáƒ” áƒáƒ áƒ˜áƒ•áƒ” áƒ•áƒ”áƒšáƒ˜: áƒ¡áƒáƒ®áƒ”áƒšáƒ˜ áƒ“áƒ ID"); return; }
    if(!/^[a-z0-9\-_\.]+$/i.test(id)){ alert("ID áƒ£áƒœáƒ“áƒ áƒ¨áƒ”áƒ˜áƒªáƒáƒ•áƒ“áƒ”áƒ¡ áƒ›áƒ®áƒáƒšáƒáƒ“ áƒáƒ¡áƒáƒ”áƒ‘áƒ¡, áƒªáƒ˜áƒ¤áƒ áƒ”áƒ‘áƒ¡, '-', '_' áƒáƒœ '.'"); return; }
    const doc = await db.collection("subjects").doc(id).get();
    if(doc.exists){ alert("áƒáƒ˜áƒ“áƒ˜ áƒ“áƒáƒ™áƒáƒ•áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ. áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ¡áƒ®áƒ•áƒ ID."); return; }

    const payload = { id, name, theme:"", globalButtons:[], weeks:[] };
    await db.collection("subjects").doc(id).set(payload);
    popup.classList.remove("active");
    await loadSubjects();
    openSubject(id);
  }

  function fadeEditor(cb){
    editorContainer.classList.add("fadeout");
    setTimeout(() => { cb(); editorContainer.classList.remove("fadeout"); }, 120);
  }

  async function openSubject(id){
    const doc = await db.collection("subjects").doc(id).get();
    if(!doc.exists){ alert("Not found"); return; }
    
    currentId = id;
    currentSubjectData = doc.data(); // This is the "pristine" data from DB
    draftSubjectData = JSON.parse(JSON.stringify(currentSubjectData)); // This is the "draft" for editing
    isDirty = false;
    setSaveState("saved");

    renderSubjectList(); // To update active class

    $("#weeksPanel").style.display = "flex";
    $("#editorTitle").textContent = `Editing: ${currentSubjectData.name}`;
    renderWeeksList();
    openWeek('global'); // Default to global settings
  }

  function renderWeeksList() {
      const list = $("#weeksList");
      list.innerHTML = "";

      const globalItem = el("div", { className: "week-item global", textContent: "Global Settings" });
      globalItem.dataset.week = "global";
      globalItem.onclick = () => openWeek('global');
      list.append(globalItem);

      for (let i = 1; i <= 13; i++) {
          const item = el("div", { className: "week-item", textContent: `áƒ™áƒ•áƒ˜áƒ áƒ ${i}` });
          item.dataset.week = i;
          item.onclick = () => openWeek(i);
          list.append(item);
      }
  }

  function openWeek(weekId) {
      // Before switching, save the state of the current editor view into the draft object
      if (currentId && currentWeek !== null) {
          updateDraftDataFromCurrentView();
      }

      currentWeek = weekId;
      document.querySelectorAll("#weeksList .week-item").forEach(item => {
          item.classList.toggle("active", String(item.dataset.week) === String(weekId));
      });

      fadeEditor(() => {
        if (weekId === 'global') {
            renderGlobalEditor();
        } else {
            renderWeekEditor(weekId);
        }
      });

      
  }

  function updateAddButtonsVisibility(container, isGlobal = false) {
    const btnsContainer = isGlobal ? container.querySelector('#globalWeekBtns') : container.querySelector('.weekBtns');
    const editorBox = isGlobal ? container.querySelector('#globalBtns') : container.querySelector('.buttons-box');

    if (!btnsContainer || !editorBox) return;

    const slideBtn = btnsContainer.querySelector('.slideBtn');
    const videoBtn = btnsContainer.querySelector('.videoBtn');
    const bookBtn = btnsContainer.querySelector('.bookBtn');
    const customBtn = btnsContainer.querySelector('.addCustom');

    const buttons = [...editorBox.querySelectorAll(".customBtnRow")];
    const hasSlide = buttons.some(row => row.dataset.type === 'slide');
    const hasVideo = buttons.some(row => row.dataset.type === 'video');
    const hasBook = buttons.some(row => row.dataset.type === 'book');
    const embedCount = buttons.filter(row => row.dataset.type !== 'custom').length;

    const limitReached = embedCount >= 3;

    if (slideBtn) slideBtn.style.display = hasSlide || limitReached ? "none" : "inline-flex";
    if (videoBtn) videoBtn.style.display = hasVideo || limitReached ? "none" : "inline-flex";
    if (bookBtn) bookBtn.style.display = hasBook || limitReached ? "none" : "inline-flex";
    if (customBtn) customBtn.style.display = limitReached ? "none" : "inline-flex";
  }

  const COLOR_NAMES = ["yellow","red","blue","green"];

  function createButtonEditor(b, container, isGlobal = false, weekIndex = null){
    const wrap = el("div",{className:"customBtnRow"});
    const selected = b.colorName || "yellow";
    const isEmbed = ['slide', 'video', 'book'].includes(b.type);

    wrap.dataset.type = b.type;
    wrap.dataset.colorName = selected;

    const labelField = isEmbed 
        ? `<input class="btnLabel" type="text" value="${b.label||""}" readonly style="background:#222; cursor: default;">`
        : `<input class="btnLabel" type="text" value="${b.label||""}" placeholder="áƒ¡áƒáƒ®áƒ”áƒšáƒ˜">`;

    const colorPalette = isEmbed
        ? ''
        : `<div class="colorPalette">
             ${COLOR_NAMES.map(c=>`<div class="colorBox ${c===selected?"active":""}" data-color="${c}"></div>`).join("")}
           </div>`;

    wrap.innerHTML = `
      <span class="drag-handle">&#x2630;</span>
      ${labelField}
      <input class="btnLink" type="text" value="${b.link||""}" placeholder="áƒšáƒ˜áƒœáƒ™áƒ˜">
      ${colorPalette}
      <button class="removeBtn" title="Remove">
        <img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/delete.svg" alt="">
      </button>
    `;

    wrap.querySelectorAll("input").forEach(inp => {
      if (!inp.readOnly) inp.addEventListener("input", markDirty);
    });

    if (!isEmbed) {
        wrap.querySelectorAll(".colorBox").forEach(box=>{
          box.onclick=()=>{
            wrap.querySelectorAll(".colorBox").forEach(bx=>bx.classList.remove("active"));
            box.classList.add("active");
            wrap.dataset.colorName = box.dataset.color;
            markDirty();
          };
        });
    }

    wrap.querySelector(".removeBtn").onclick = () => { 
        wrap.remove(); 
        updateAddButtonsVisibility(container, isGlobal);
        markDirty(); 
    };
    return wrap;
  }

  function renderGlobalEditor() {
      editorContainer.innerHTML = `
        <h2>Global Settings</h2>
        <label>áƒ¡áƒáƒ’áƒœáƒ˜áƒ¡ ID</label>
        <input id="subjectId" disabled>
        <label>áƒ¡áƒáƒ’áƒœáƒ˜áƒ¡ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜</label>
        <input id="subjectName">
        <label>áƒ¡áƒáƒ’áƒœáƒ˜áƒ¡ áƒ¡áƒ£áƒ áƒáƒ—áƒ˜</label>
        <div class="image-upload-container">
            <input type="file" accept="image/*" style="display: none;">
            <div class="drop-zone"><p>áƒ’áƒáƒ“áƒ›áƒáƒáƒ—áƒ áƒ˜áƒ” áƒ¡áƒ£áƒ áƒáƒ—áƒ˜ áƒáƒ¥ áƒáƒœ <span class="click-to-upload">áƒ“áƒáƒáƒ­áƒ˜áƒ áƒ” áƒáƒ¡áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒáƒ“</span></p></div>
            <div class="image-preview" style="display: none;">
                <img class="uploaded-image" src="" alt="Uploaded Image">
                <button class="delete-image-btn"><span class="material-symbols-outlined">close</span></button>
            </div>
        </div>
        <label>áƒ¡áƒáƒ’áƒœáƒ˜áƒ¡ áƒ¡áƒ˜áƒ›áƒ‘áƒáƒšáƒ</label>
        <div class="symbol-selector">
            <span class="material-symbols-outlined" id="subjectSymbolDisplay"></span>
            <input type="text" id="subjectSymbolName" placeholder="áƒ¡áƒ˜áƒ›áƒ‘áƒáƒšáƒáƒ¡ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜ (áƒ›áƒáƒ’: home)">
        </div>

        <label style="margin-top: 20px;">áƒšáƒ”áƒ¥áƒªáƒ˜áƒ˜áƒ¡ áƒ¢áƒ˜áƒáƒ˜áƒ¡ áƒ¨áƒáƒ‘áƒšáƒáƒœáƒ”áƒ‘áƒ˜</label>
        <div id="lectureTypeTemplates" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <button class="template-btn" data-template="1" title="Week 1: Lecture, Week 7: Midterm, Others: Lecture (Quiz)">áƒšáƒ”áƒ¥áƒªáƒ˜áƒ, áƒ¡áƒ£áƒš áƒ¥áƒ•áƒ˜áƒ–áƒ”áƒ‘áƒ˜, áƒ¨áƒ£áƒáƒ¨áƒ˜ áƒ¨áƒ£áƒáƒšáƒ”áƒ“áƒ£áƒ áƒ˜</button>
            <button class="template-btn" data-template="2" title="Week 1: Lecture, Others: Lecture (Quiz)">áƒšáƒ”áƒ¥áƒªáƒ˜áƒ,áƒ¡áƒ£áƒš áƒ¥áƒ•áƒ˜áƒ–áƒ”áƒ‘áƒ˜, áƒ¨áƒ£áƒáƒšáƒ”áƒ“áƒ£áƒ áƒ˜áƒ¡ áƒ’áƒáƒ áƒ”áƒ¨áƒ”</button>
            <button class="template-btn" data-template="3" title="Odd: Lecture, Even: Lecture (Quiz), Week 13: Presentation">áƒšáƒ”áƒ¥áƒªáƒ˜áƒ, áƒ¨áƒ£áƒáƒšáƒ”áƒ“áƒ£áƒ áƒ˜ áƒ“áƒ áƒáƒ áƒ”áƒ–áƒ”áƒœáƒ¢áƒáƒªáƒ˜áƒ</button>
        </div>

        <div class="global">
            <h3>áƒ–áƒáƒ’áƒáƒ“áƒ˜ áƒ áƒ”áƒ¡áƒ£áƒ áƒ¡áƒ”áƒ‘áƒ˜</h3>
            <div id="globalBtns"></div>
            <div class="weekBtns" id="globalWeekBtns" style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="addBtn slideBtn" style="background-color:#e8980e;"><img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" width="18" height="18" alt="">áƒ¡áƒšáƒáƒ˜áƒ“áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ</button>
                <button class="addBtn videoBtn" style="background-color:#eb1515;"><img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" width="18" height="18" alt="">áƒ•áƒ˜áƒ“áƒ”áƒáƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ</button>
                <button class="addBtn bookBtn" style="background-color:#0e86e8;"><img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" width="18" height="18" alt="">áƒ¬áƒ˜áƒ’áƒœáƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ</button>
                <button class="addBtn addCustom" style="background-color:#323742;"><img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" width="18" height="18" alt="">áƒ¡áƒ®áƒ•áƒ áƒ áƒ”áƒ¡áƒ£áƒ áƒ¡áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ</button>
            </div>
        </div>
      `;

      $("#subjectId").value = currentId;
      $("#subjectName").value = draftSubjectData.name || "";
      const symbol = draftSubjectData.theme || "";
      $("#subjectSymbolName").value = symbol;
      const symbolDisplay = $("#subjectSymbolDisplay");
      symbolDisplay.textContent = symbol;
      symbolDisplay.classList.toggle("material-symbols-outlined", !!symbol);

      setupImageUpload(editorContainer); // This needs to be adapted to use draftSubjectData

      const box = $("#globalBtns");
      (draftSubjectData.globalButtons || []).forEach(b => box.append(createButtonEditor(b, editorContainer, true))); // Use only the draft data
      new Sortable(box, { animation: 150, handle: '.drag-handle', onEnd: markDirty });

      const checkEmbedLimit = () => {
          const embedCount = [...box.querySelectorAll(".customBtnRow")].filter(row => row.dataset.type !== 'custom').length;
          if (embedCount >= 3) { alert("You can add a maximum of 3 embeds globally."); return false; }
          return true;
      };

      editorContainer.querySelector(".slideBtn").onclick = () => {
          if (!checkEmbedLimit() || [...box.querySelectorAll(".customBtnRow")].some(r => r.dataset.type === 'slide')) return;
          box.append(createButtonEditor({type: 'slide', label:"áƒ¡áƒšáƒáƒ˜áƒ“áƒ˜", link:"DRIVELINK/preview", colorName:"yellow"}, editorContainer, true));
          updateAddButtonsVisibility(editorContainer, true); markDirty();
      };
      editorContainer.querySelector(".videoBtn").onclick = () => {
          if (!checkEmbedLimit() || [...box.querySelectorAll(".customBtnRow")].some(r => r.dataset.type === 'video')) return;
          box.append(createButtonEditor({type: 'video', label:"áƒ•áƒ˜áƒ“áƒ”áƒ", link:"", colorName:"red"}, editorContainer, true));
          updateAddButtonsVisibility(editorContainer, true); markDirty();
      };
      editorContainer.querySelector(".bookBtn").onclick = () => {
          if (!checkEmbedLimit() || [...box.querySelectorAll(".customBtnRow")].some(r => r.dataset.type === 'book')) return;
          box.append(createButtonEditor({type: 'book', label:"áƒ¬áƒ˜áƒ’áƒœáƒ˜", link:"", colorName:"blue"}, editorContainer, true));
          updateAddButtonsVisibility(editorContainer, true); markDirty();
      };
      editorContainer.querySelector(".addCustom").onclick = () => {
          box.append(createButtonEditor({type: 'custom', label:"", link:"", colorName:"green"}, editorContainer, true));
          markDirty();
      };

      updateAddButtonsVisibility(editorContainer, true);

      // Event listeners for dirty marking
      ["#subjectName", "#subjectSymbolName"].forEach(sel => {
          $(sel).addEventListener("input", (e) => {
              markDirty();
              if (sel === "#subjectSymbolName") {
                  symbolDisplay.textContent = e.target.value;
                  symbolDisplay.classList.toggle("material-symbols-outlined", !!e.target.value);
              }
          });
      });

      // Lecture Type Template Logic
      editorContainer.querySelectorAll(".template-btn").forEach(btn => {
          btn.onclick = () => {
              if (!confirm("Are you sure you want to apply this template? This will overwrite all existing week types for this subject.")) {
                  return;
              }

              const template = btn.dataset.template;
              
              for (let i = 1; i <= 13; i++) {
                  let weekData = draftSubjectData.weeks.find(w => w.week === i); // Use draft data
                  if (!weekData) {
                      weekData = { week: i, topic: "", buttons: [] };
                      draftSubjectData.weeks.push(weekData); // Add to draft data
                  }

                  if (template === "1") {
                      if (i === 1) weekData.type = "áƒšáƒ”áƒ¥áƒªáƒ˜áƒ";
                      else if (i === 7) weekData.type = "áƒ¨áƒ£áƒáƒšáƒ”áƒ“áƒ£áƒ áƒ˜";
                      else weekData.type = "áƒšáƒ”áƒ¥áƒªáƒ˜áƒ (áƒ¥áƒ•áƒ˜áƒ–áƒ˜)";
                  } else if (template === "2") {
                      if (i === 1) weekData.type = "áƒšáƒ”áƒ¥áƒªáƒ˜áƒ";
                      else weekData.type = "áƒšáƒ”áƒ¥áƒªáƒ˜áƒ (áƒ¥áƒ•áƒ˜áƒ–áƒ˜)";
                  } else if (template === "3") {
                      if (i === 13) weekData.type = "áƒáƒ áƒ”áƒ–áƒ”áƒœáƒ¢áƒáƒªáƒ˜áƒ";
                      else if (i % 2 !== 0) weekData.type = "áƒšáƒ”áƒ¥áƒªáƒ˜áƒ"; // Odd
                      else weekData.type = "áƒšáƒ”áƒ¥áƒªáƒ˜áƒ (áƒ¥áƒ•áƒ˜áƒ–áƒ˜)"; // Even
                  }
              }

              // Sort weeks array just in case new weeks were added out of order
              draftSubjectData.weeks.sort((a, b) => a.week - b.week);

              markDirty();
              alert("Template applied! Don't forget to click 'Apply' to save the changes.");

              // If a week editor is currently open, refresh it to show the new type
              if (currentWeek !== 'global') {
                  const weekNumToRefresh = currentWeek;
                  openWeek(weekNumToRefresh);
              }
          };
      });
  }

  function renderWeekEditor(weekNum) {
      const weekData = (draftSubjectData.weeks || []).find(w => w.week === weekNum) || {};
      editorContainer.innerHTML = `
        <h2>áƒ™áƒ•áƒ˜áƒ áƒ ${weekNum}</h2>
        <label>áƒ—áƒ”áƒ›áƒ˜áƒ¡ áƒ¡áƒáƒ—áƒáƒ£áƒ áƒ˜</label>
        <div class="topicField" contenteditable="true">${weekData.topic || ""}</div>

        <label>áƒšáƒ”áƒ¥áƒªáƒ˜áƒ˜áƒ¡ áƒ¢áƒ˜áƒáƒ˜</label>
        <select class="weekType">
          <option value="áƒšáƒ”áƒ¥áƒªáƒ˜áƒ">áƒšáƒ”áƒ¥áƒªáƒ˜áƒ</option>
          <option value="áƒšáƒ”áƒ¥áƒªáƒ˜áƒ (áƒ¥áƒ•áƒ˜áƒ–áƒ˜)">áƒšáƒ”áƒ¥áƒªáƒ˜áƒ (áƒ¥áƒ•áƒ˜áƒ–áƒ˜)</option>
          <option value="áƒ¨áƒ£áƒáƒšáƒ”áƒ“áƒ£áƒ áƒ˜">áƒ¨áƒ£áƒáƒšáƒ”áƒ“áƒ£áƒ áƒ˜</option>
          <option value="áƒáƒ áƒ”áƒ–áƒ”áƒœáƒ¢áƒáƒªáƒ˜áƒ">áƒáƒ áƒ”áƒ–áƒ”áƒœáƒ¢áƒáƒªáƒ˜áƒ</option>
        </select>

        <label>áƒ‘áƒ›áƒ£áƒšáƒ”áƒ‘áƒ˜</label>
        <div class="buttons-box"></div>

        <div class="weekBtns" style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="addBtn slideBtn" style="background-color:#e8980e;"><img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" width="18" height="18" alt="">áƒ¡áƒšáƒáƒ˜áƒ“áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ</button>
          <button class="addBtn videoBtn" style="background-color:#eb1515;"><img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" width="18" height="18" alt="">áƒ•áƒ˜áƒ“áƒ”áƒáƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ</button>
          <button class="addBtn bookBtn" style="background-color:#0e86e8;"><img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" width="18" height="18" alt="">áƒ¬áƒ˜áƒ’áƒœáƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ</button>
          <button class="addBtn addCustom" style="background-color:#323742;"><img src="https://github.com/WEEKGE/weeksy-assets00002222/raw/refs/heads/main/svgs/add.svg" width="18" height="18" alt="">áƒ¡áƒ®áƒ•áƒ áƒ áƒ”áƒ¡áƒ£áƒ áƒ¡áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ</button>
        </div>
      `;

      const typeSelect = editorContainer.querySelector('.weekType');
      if (weekData.type) typeSelect.value = weekData.type;

      const btnBox = editorContainer.querySelector('.buttons-box');
      (weekData.buttons || []).forEach(b => btnBox.append(createButtonEditor(b, editorContainer, false, weekNum)));
      new Sortable(btnBox, { animation: 150, handle: '.drag-handle', onEnd: markDirty });

      const checkEmbedLimit = () => {
          const embedCount = [...btnBox.querySelectorAll(".customBtnRow")].filter(row => row.dataset.type !== 'custom').length;
          if (embedCount >= 3) { alert("You can add a maximum of 3 embeds per week."); return false; }
          return true;
      };

      editorContainer.querySelector(".slideBtn").onclick = () => {
          if (!checkEmbedLimit() || [...btnBox.querySelectorAll(".customBtnRow")].some(r => r.dataset.type === 'slide')) return;
          btnBox.append(createButtonEditor({type: 'slide', label:"áƒ¡áƒšáƒáƒ˜áƒ“áƒ˜", link:"DRIVELINK/preview", colorName:"yellow"}, editorContainer, false, weekNum));
          updateAddButtonsVisibility(editorContainer, false); markDirty();
      };
      editorContainer.querySelector(".videoBtn").onclick = () => {
          if (!checkEmbedLimit() || [...btnBox.querySelectorAll(".customBtnRow")].some(r => r.dataset.type === 'video')) return;
          btnBox.append(createButtonEditor({type: 'video', label:"áƒ•áƒ˜áƒ“áƒ”áƒ", link:"", colorName:"red"}, editorContainer, false, weekNum));
          updateAddButtonsVisibility(editorContainer, false); markDirty();
      };
      editorContainer.querySelector(".bookBtn").onclick = () => {
          if (!checkEmbedLimit() || [...btnBox.querySelectorAll(".customBtnRow")].some(r => r.dataset.type === 'book')) return;
          btnBox.append(createButtonEditor({type: 'book', label:"áƒ¬áƒ˜áƒ’áƒœáƒ˜", link:"", colorName:"blue"}, editorContainer, false, weekNum));
          updateAddButtonsVisibility(editorContainer, false); markDirty();
      };
      editorContainer.querySelector(".addCustom").onclick = () => {
          btnBox.append(createButtonEditor({type: 'custom', label:"", link:"", colorName:"green"}, editorContainer, false, weekNum));
          markDirty();
      };

      updateAddButtonsVisibility(editorContainer, false);

      editorContainer.querySelector(".topicField").addEventListener("input", markDirty);
      typeSelect.addEventListener("input", markDirty);

      // Handle pasting plain text
      editorContainer.querySelector(".topicField").addEventListener('paste', (event) => {
          event.preventDefault();
          const text = (event.clipboardData || window.clipboardData).getData('text/plain');
          document.execCommand('insertText', false, text);
      });
  }

  /**
   * Reads the data from the currently visible editor (global or a specific week)
   * and updates the draftSubjectData object with those values.
   */
  function updateDraftDataFromCurrentView() {
    if (!currentId || currentWeek === null) return;

    if (currentWeek === 'global') {
        draftSubjectData.name = $("#subjectName").value.trim();
        draftSubjectData.theme = $("#subjectSymbolName").value.trim();
        draftSubjectData.imageUrl = currentImageUrl;
        draftSubjectData.globalButtons = [...editorContainer.querySelectorAll("#globalBtns .customBtnRow")].map(b => ({
            type: b.dataset.type,
            label: b.querySelector(".btnLabel").value,
            link: b.querySelector(".btnLink").value,
            colorName: b.dataset.colorName
        }));
    } else {
        const weekNum = parseInt(currentWeek, 10);
        let weekData = draftSubjectData.weeks.find(w => w.week === weekNum);
        if (!weekData) {
            weekData = { week: weekNum };
            draftSubjectData.weeks.push(weekData);
        }

        weekData.topic = (editorContainer.querySelector(".topicField")?.innerHTML || "").trim();
        weekData.type = (editorContainer.querySelector(".weekType")?.value) || "áƒšáƒ”áƒ¥áƒªáƒ˜áƒ";
        weekData.buttons = [...(editorContainer.querySelectorAll(".buttons-box .customBtnRow") || [])].map(b => ({
            type: b.dataset.type,
            label: b.querySelector(".btnLabel").value.trim(),
            link: b.querySelector(".btnLink").value.trim(),
            colorName: b.dataset.colorName
        }));

        // Ensure weeks are sorted
        draftSubjectData.weeks.sort((a, b) => a.week - b.week);
    }
  }

  async function saveNow(){
    if(!currentId){ alert("áƒ¯áƒ”áƒ  áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ¡áƒáƒ’áƒáƒœáƒ˜."); return; }

    // First, ensure the data from the currently visible editor is collected into the draft
    updateDraftDataFromCurrentView();

    // The payload to save is the entire draft object
    const payload = draftSubjectData;
    if (!payload) return;

    try{
      setSaveState("wait");
      await db.collection("subjects").doc(currentId).set(payload, { merge:true });
      
      // Update local cache
      currentSubjectData = payload;
      draftSubjectData = JSON.parse(JSON.stringify(currentSubjectData)); // Re-sync draft with new pristine data
      const idx = subjects.findIndex(s => s.id === currentId);
      if(idx > -1) subjects[idx] = { ...subjects[idx], ...payload };
      
      setSaveState("saved");
      renderSubjectList(); // Update list in case name changed
    }catch(e){
      console.error(e);
      setSaveState("error");
      alert("âŒ áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ˜áƒ¡áƒáƒ¡ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒáƒ");
    }
  }

  async function deleteCurrent(){
    if(!currentId){ alert("áƒ¯áƒ”áƒ  áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ¡áƒáƒ’áƒáƒœáƒ˜."); return; }
    if(!confirm("Delete this subject?")) return;
    try{
      setSaveState("wait");
      await db.collection("subjects").doc(currentId).delete();
      
      currentId = null;
      currentSubjectData = null;
      draftSubjectData = null;
      currentWeek = null;
      
      $("#weeksPanel").style.display = "none";
      editorContainer.innerHTML = "";
      $("#editorTitle").textContent = "áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ¡áƒáƒ’áƒáƒœáƒ˜ áƒ’áƒáƒ“áƒáƒ¡áƒáƒ™áƒ”áƒ—áƒ”áƒ‘áƒšáƒáƒ“";

      await loadSubjects();
      setSaveState("saved");
    }catch(e){
      console.error(e);
      setSaveState("error");
      alert("âŒ áƒ¬áƒáƒ¨áƒšáƒ˜áƒ¡áƒáƒ¡ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒáƒ");
    }
  }

/* === Hold-to-Delete Delay Setup === */
  function addHoldToDelete(btn, action) {
    let progress = 0, interval;
    let bar = btn.querySelector(".delete-progress");
    if (!bar) {
      bar = document.createElement("span");
      bar.className = "delete-progress";
      btn.prepend(bar);
    }

    btn.addEventListener("mousedown", () => {
      progress = 0;
      bar.style.width = "0%";
      interval = setInterval(() => {
        progress += 100 / 20; // fill over ~1s
        bar.style.width = progress + "%";
        if (progress >= 100) {
          clearInterval(interval);
          bar.style.width = "100%";
          action();
        }
      }, 50);
    });

    ["mouseup", "mouseleave"].forEach(ev => {
      btn.addEventListener(ev, () => {
        clearInterval(interval);
        bar.style.width = "0%";
      });
    });
  }

  /* === Wire buttons === */
  $("#applyNavBtn").onclick = saveNow;
  addHoldToDelete($("#deleteNavBtn"), deleteCurrent);

  // Ctrl+S => Apply
  document.addEventListener("keydown", (e)=>{
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="s"){
      e.preventDefault();
      saveNow();
    }
  });

  /* --- Formatting shortcuts (bold/italic/underline) --- */
  document.addEventListener("keydown", e => {
    if (e.ctrlKey && ["b","i","u"].includes(e.key.toLowerCase())) {
      if (document.activeElement.classList.contains('topicField')) {
        e.preventDefault();
        const cmd = e.key.toLowerCase() === "b" ? "bold" :
                    e.key.toLowerCase() === "i" ? "italic" : "underline";
        document.execCommand(cmd, false, null);
        markDirty();
      }
    }
  });
}
</script>

</body>
</html>
